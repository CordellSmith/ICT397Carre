<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Assignment2 - OOber Taxi: C:/Users/New/Documents/Games_Technology/Year4_Semester1/ICT397/~My Work/Assignment2/ICT397Carre/CarreGameEngine/Dependencies/BulletPhysicsEngine/include/BulletSoftBody/btSoftBodyHelpers.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>C:/Users/New/Documents/Games_Technology/Year4_Semester1/ICT397/~My Work/Assignment2/ICT397Carre/CarreGameEngine/Dependencies/BulletPhysicsEngine/include/BulletSoftBody/btSoftBodyHelpers.cpp</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">Bullet Continuous Collision Detection and Physics Library</span>
<a name="l00003"></a>00003 <span class="comment">Copyright (c) 2003-2006 Erwin Coumans  http://continuousphysics.com/Bullet/</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">This software is provided 'as-is', without any express or implied warranty.</span>
<a name="l00006"></a>00006 <span class="comment">In no event will the authors be held liable for any damages arising from the use of this software.</span>
<a name="l00007"></a>00007 <span class="comment">Permission is granted to anyone to use this software for any purpose,</span>
<a name="l00008"></a>00008 <span class="comment">including commercial applications, and to alter it and redistribute it freely,</span>
<a name="l00009"></a>00009 <span class="comment">subject to the following restrictions:</span>
<a name="l00010"></a>00010 <span class="comment"></span>
<a name="l00011"></a>00011 <span class="comment">1. The origin of this software must not be misrepresented; you must not claim that you wrote the original software. If you use this software in a product, an acknowledgment in the product documentation would be appreciated but is not required.</span>
<a name="l00012"></a>00012 <span class="comment">2. Altered source versions must be plainly marked as such, and must not be misrepresented as being the original software.</span>
<a name="l00013"></a>00013 <span class="comment">3. This notice may not be removed or altered from any source distribution.</span>
<a name="l00014"></a>00014 <span class="comment">*/</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="preprocessor">#include "btSoftBodyInternals.h"</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include "btSoftBodyHelpers.h"</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include "LinearMath/btConvexHull.h"</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include "LinearMath/btConvexHullComputer.h"</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="comment">//</span>
<a name="l00026"></a>00026 <span class="keyword">static</span> <span class="keywordtype">void</span>                             drawVertex(     <a class="code" href="classbt_i_debug_draw.html">btIDebugDraw</a>* idraw,
<a name="l00027"></a>00027                                                                    <span class="keyword">const</span> btVector3&amp; x,btScalar s,<span class="keyword">const</span> btVector3&amp; c)
<a name="l00028"></a>00028 {
<a name="l00029"></a>00029         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(x-btVector3(s,0,0),x+btVector3(s,0,0),c);
<a name="l00030"></a>00030         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(x-btVector3(0,s,0),x+btVector3(0,s,0),c);
<a name="l00031"></a>00031         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(x-btVector3(0,0,s),x+btVector3(0,0,s),c);
<a name="l00032"></a>00032 }
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="comment">//</span>
<a name="l00035"></a>00035 <span class="keyword">static</span> <span class="keywordtype">void</span>                             drawBox(        <a class="code" href="classbt_i_debug_draw.html">btIDebugDraw</a>* idraw,
<a name="l00036"></a>00036                                                                 <span class="keyword">const</span> btVector3&amp; mins,
<a name="l00037"></a>00037                                                                 <span class="keyword">const</span> btVector3&amp; maxs,
<a name="l00038"></a>00038                                                                 <span class="keyword">const</span> btVector3&amp; color)
<a name="l00039"></a>00039 {
<a name="l00040"></a>00040         <span class="keyword">const</span> btVector3 c[]={   btVector3(mins.x(),mins.y(),mins.z()),
<a name="l00041"></a>00041                 btVector3(maxs.x(),mins.y(),mins.z()),
<a name="l00042"></a>00042                 btVector3(maxs.x(),maxs.y(),mins.z()),
<a name="l00043"></a>00043                 btVector3(mins.x(),maxs.y(),mins.z()),
<a name="l00044"></a>00044                 btVector3(mins.x(),mins.y(),maxs.z()),
<a name="l00045"></a>00045                 btVector3(maxs.x(),mins.y(),maxs.z()),
<a name="l00046"></a>00046                 btVector3(maxs.x(),maxs.y(),maxs.z()),
<a name="l00047"></a>00047                 btVector3(mins.x(),maxs.y(),maxs.z())};
<a name="l00048"></a>00048         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(c[0],c[1],color);idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(c[1],c[2],color);
<a name="l00049"></a>00049         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(c[2],c[3],color);idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(c[3],c[0],color);
<a name="l00050"></a>00050         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(c[4],c[5],color);idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(c[5],c[6],color);
<a name="l00051"></a>00051         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(c[6],c[7],color);idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(c[7],c[4],color);
<a name="l00052"></a>00052         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(c[0],c[4],color);idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(c[1],c[5],color);
<a name="l00053"></a>00053         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(c[2],c[6],color);idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(c[3],c[7],color);
<a name="l00054"></a>00054 }
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="comment">//</span>
<a name="l00057"></a>00057 <span class="keyword">static</span> <span class="keywordtype">void</span>                             drawTree(       <a class="code" href="classbt_i_debug_draw.html">btIDebugDraw</a>* idraw,
<a name="l00058"></a>00058                                                                  <span class="keyword">const</span> btDbvtNode* node,
<a name="l00059"></a>00059                                                                  <span class="keywordtype">int</span> depth,
<a name="l00060"></a>00060                                                                  <span class="keyword">const</span> btVector3&amp; ncolor,
<a name="l00061"></a>00061                                                                  <span class="keyword">const</span> btVector3&amp; lcolor,
<a name="l00062"></a>00062                                                                  <span class="keywordtype">int</span> mindepth,
<a name="l00063"></a>00063                                                                  <span class="keywordtype">int</span> maxdepth)
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065         <span class="keywordflow">if</span>(node)
<a name="l00066"></a>00066         {
<a name="l00067"></a>00067                 <span class="keywordflow">if</span>(node-&gt;isinternal()&amp;&amp;((depth&lt;maxdepth)||(maxdepth&lt;0)))
<a name="l00068"></a>00068                 {
<a name="l00069"></a>00069                         drawTree(idraw,node-&gt;childs[0],depth+1,ncolor,lcolor,mindepth,maxdepth);
<a name="l00070"></a>00070                         drawTree(idraw,node-&gt;childs[1],depth+1,ncolor,lcolor,mindepth,maxdepth);
<a name="l00071"></a>00071                 }
<a name="l00072"></a>00072                 <span class="keywordflow">if</span>(depth&gt;=mindepth)
<a name="l00073"></a>00073                 {
<a name="l00074"></a>00074                         <span class="keyword">const</span> btScalar  scl=(btScalar)(node-&gt;isinternal()?1:1);
<a name="l00075"></a>00075                         <span class="keyword">const</span> btVector3 mi=node-&gt;volume.Center()-node-&gt;volume.Extents()*scl;
<a name="l00076"></a>00076                         <span class="keyword">const</span> btVector3 mx=node-&gt;volume.Center()+node-&gt;volume.Extents()*scl;
<a name="l00077"></a>00077                         drawBox(idraw,mi,mx,node-&gt;isleaf()?lcolor:ncolor);
<a name="l00078"></a>00078                 }
<a name="l00079"></a>00079         }
<a name="l00080"></a>00080 }
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="comment">//</span>
<a name="l00083"></a>00083 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;
<a name="l00084"></a>00084 <span class="keyword">static</span> <span class="keyword">inline</span> T                         sum(<span class="keyword">const</span> <a class="code" href="classbt_aligned_object_array.html">btAlignedObjectArray&lt;T&gt;</a>&amp; items)
<a name="l00085"></a>00085 {
<a name="l00086"></a>00086         T       v;
<a name="l00087"></a>00087         <span class="keywordflow">if</span>(items.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>())
<a name="l00088"></a>00088         {
<a name="l00089"></a>00089                 v=items[0];
<a name="l00090"></a>00090                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=1,ni=items.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>();i&lt;ni;++i)
<a name="l00091"></a>00091                 {
<a name="l00092"></a>00092                         v+=items[i];
<a name="l00093"></a>00093                 }
<a name="l00094"></a>00094         }
<a name="l00095"></a>00095         <span class="keywordflow">return</span>(v);
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="comment">//</span>
<a name="l00099"></a>00099 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T,<span class="keyword">typename</span> Q&gt;
<a name="l00100"></a>00100 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>                      <span class="keyword">add</span>(<a class="code" href="classbt_aligned_object_array.html">btAlignedObjectArray&lt;T&gt;</a>&amp; items,<span class="keyword">const</span> Q&amp; value)
<a name="l00101"></a>00101 {
<a name="l00102"></a>00102         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0,ni=items.size();i&lt;ni;++i)
<a name="l00103"></a>00103         {
<a name="l00104"></a>00104                 items[i]+=value;
<a name="l00105"></a>00105         }
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="comment">//</span>
<a name="l00109"></a>00109 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T,<span class="keyword">typename</span> Q&gt;
<a name="l00110"></a>00110 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>                      mul(<a class="code" href="classbt_aligned_object_array.html">btAlignedObjectArray&lt;T&gt;</a>&amp; items,<span class="keyword">const</span> Q&amp; value)
<a name="l00111"></a>00111 {
<a name="l00112"></a>00112         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0,ni=items.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>();i&lt;ni;++i)
<a name="l00113"></a>00113         {
<a name="l00114"></a>00114                 items[i]*=value;
<a name="l00115"></a>00115         }
<a name="l00116"></a>00116 }
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 <span class="comment">//</span>
<a name="l00119"></a>00119 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;
<a name="l00120"></a>00120 <span class="keyword">static</span> <span class="keyword">inline</span> T                         average(<span class="keyword">const</span> <a class="code" href="classbt_aligned_object_array.html">btAlignedObjectArray&lt;T&gt;</a>&amp; items)
<a name="l00121"></a>00121 {
<a name="l00122"></a>00122         <span class="keyword">const</span> btScalar  n=(btScalar)(items.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>()&gt;0?items.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>():1);
<a name="l00123"></a>00123         <span class="keywordflow">return</span>(sum(items)/n);
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 <span class="preprocessor">#if 0</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span><span class="comment">//</span>
<a name="l00128"></a>00128  <span class="keyword">inline</span> <span class="keyword">static</span> btScalar         tetravolume(<span class="keyword">const</span> btVector3&amp; x0,
<a name="l00129"></a>00129                                                                                 <span class="keyword">const</span> btVector3&amp; x1,
<a name="l00130"></a>00130                                                                                 <span class="keyword">const</span> btVector3&amp; x2,
<a name="l00131"></a>00131                                                                                 <span class="keyword">const</span> btVector3&amp; x3)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133         <span class="keyword">const</span> btVector3 a=x1-x0;
<a name="l00134"></a>00134         <span class="keyword">const</span> btVector3 b=x2-x0;
<a name="l00135"></a>00135         <span class="keyword">const</span> btVector3 c=x3-x0;
<a name="l00136"></a>00136         <span class="keywordflow">return</span>(btDot(a,btCross(b,c)));
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 <span class="preprocessor">#endif</span>
<a name="l00139"></a>00139 <span class="preprocessor"></span>
<a name="l00140"></a>00140 <span class="comment">//</span>
<a name="l00141"></a>00141 <span class="preprocessor">#if 0</span>
<a name="l00142"></a>00142 <span class="preprocessor"></span><span class="keyword">static</span> btVector3                stresscolor(btScalar stress)
<a name="l00143"></a>00143 {
<a name="l00144"></a>00144         <span class="keyword">static</span> <span class="keyword">const</span> btVector3  spectrum[]=     {       btVector3(1,0,1),
<a name="l00145"></a>00145                 btVector3(0,0,1),
<a name="l00146"></a>00146                 btVector3(0,1,1),
<a name="l00147"></a>00147                 btVector3(0,1,0),
<a name="l00148"></a>00148                 btVector3(1,1,0),
<a name="l00149"></a>00149                 btVector3(1,0,0),
<a name="l00150"></a>00150                 btVector3(1,0,0)};
<a name="l00151"></a>00151         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span>                ncolors=<span class="keyword">sizeof</span>(spectrum)/<span class="keyword">sizeof</span>(spectrum[0])-1;
<a name="l00152"></a>00152         <span class="keyword">static</span> <span class="keyword">const</span> btScalar   <a class="code" href="group__gtc__constants.html#gbc71dfc97639e8010a39c1892e68ed9b">one</a>=1;
<a name="l00153"></a>00153         stress=btMax&lt;btScalar&gt;(0,btMin&lt;btScalar&gt;(1,stress))*ncolors;
<a name="l00154"></a>00154         <span class="keyword">const</span> <span class="keywordtype">int</span>                               sel=(int)stress;
<a name="l00155"></a>00155         <span class="keyword">const</span> btScalar                  frc=stress-sel;
<a name="l00156"></a>00156         <span class="keywordflow">return</span>(spectrum[sel]+(spectrum[sel+1]-spectrum[sel])*frc);
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 <span class="preprocessor">#endif</span>
<a name="l00159"></a>00159 <span class="preprocessor"></span>
<a name="l00160"></a>00160 <span class="comment">//</span>
<a name="l00161"></a>00161 <span class="keywordtype">void</span>                    btSoftBodyHelpers::Draw(        <a class="code" href="classbt_soft_body.html">btSoftBody</a>* psb,
<a name="l00162"></a>00162                                                                                 <a class="code" href="classbt_i_debug_draw.html">btIDebugDraw</a>* idraw,
<a name="l00163"></a>00163                                                                                 <span class="keywordtype">int</span> drawflags)
<a name="l00164"></a>00164 {
<a name="l00165"></a>00165         <span class="keyword">const</span> btScalar          scl=(btScalar)0.1;
<a name="l00166"></a>00166         <span class="keyword">const</span> btScalar          nscl=scl*5;
<a name="l00167"></a>00167         <span class="keyword">const</span> btVector3         lcolor=btVector3(0,0,0);
<a name="l00168"></a>00168         <span class="keyword">const</span> btVector3         ncolor=btVector3(1,1,1);
<a name="l00169"></a>00169         <span class="keyword">const</span> btVector3         ccolor=btVector3(1,0,0);
<a name="l00170"></a>00170         <span class="keywordtype">int</span> i,j,nj;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172                 <span class="comment">/* Clusters     */</span> 
<a name="l00173"></a>00173         <span class="keywordflow">if</span>(0!=(drawflags&amp;fDrawFlags::Clusters))
<a name="l00174"></a>00174         {
<a name="l00175"></a>00175                 srand(1806);
<a name="l00176"></a>00176                 <span class="keywordflow">for</span>(i=0;i&lt;psb-&gt;<a class="code" href="classbt_soft_body.html#9579ec7fb7f43787cf4bc74eed279f48">m_clusters</a>.size();++i)
<a name="l00177"></a>00177                 {
<a name="l00178"></a>00178                         <span class="keywordflow">if</span>(psb-&gt;<a class="code" href="classbt_soft_body.html#9579ec7fb7f43787cf4bc74eed279f48">m_clusters</a>[i]-&gt;m_collide)
<a name="l00179"></a>00179                         {
<a name="l00180"></a>00180                                 btVector3                                               color(  rand()/(btScalar)RAND_MAX,
<a name="l00181"></a>00181                                         rand()/(btScalar)RAND_MAX,
<a name="l00182"></a>00182                                         rand()/(btScalar)RAND_MAX);
<a name="l00183"></a>00183                                 color=color.normalized()*0.75;
<a name="l00184"></a>00184                                 <a class="code" href="classbt_aligned_object_array.html">btAlignedObjectArray&lt;btVector3&gt;</a> vertices;
<a name="l00185"></a>00185                                 vertices.<a class="code" href="classbt_aligned_object_array.html#6a48cd9cb91d0cfa50ee1c70ef485190">resize</a>(psb-&gt;<a class="code" href="classbt_soft_body.html#9579ec7fb7f43787cf4bc74eed279f48">m_clusters</a>[i]-&gt;m_nodes.size());
<a name="l00186"></a>00186                                 <span class="keywordflow">for</span>(j=0,nj=vertices.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>();j&lt;nj;++j)
<a name="l00187"></a>00187                                 {                               
<a name="l00188"></a>00188                                         vertices[j]=psb-&gt;<a class="code" href="classbt_soft_body.html#9579ec7fb7f43787cf4bc74eed279f48">m_clusters</a>[i]-&gt;m_nodes[j]-&gt;m_x;
<a name="l00189"></a>00189                                 }
<a name="l00190"></a>00190 <span class="preprocessor">#define USE_NEW_CONVEX_HULL_COMPUTER</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span><span class="preprocessor">#ifdef USE_NEW_CONVEX_HULL_COMPUTER</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>                                <a class="code" href="classbt_convex_hull_computer.html">btConvexHullComputer</a>    computer;
<a name="l00193"></a>00193                                 <span class="keywordtype">int</span> stride = <span class="keyword">sizeof</span>(btVector3);
<a name="l00194"></a>00194                                 <span class="keywordtype">int</span> count = vertices.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>();
<a name="l00195"></a>00195                                 btScalar shrink=0.f;
<a name="l00196"></a>00196                                 btScalar shrinkClamp=0.f;
<a name="l00197"></a>00197                                 computer.<a class="code" href="classbt_convex_hull_computer.html#0f3338cfe7aee659da209bdd98a7a52b">compute</a>(&amp;vertices[0].getX(),stride,count,shrink,shrinkClamp);
<a name="l00198"></a>00198                                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;computer.<a class="code" href="classbt_convex_hull_computer.html#c63efa14dad485f2210ac9f6a33bbd95">faces</a>.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>();i++)
<a name="l00199"></a>00199                                 {
<a name="l00200"></a>00200 
<a name="l00201"></a>00201                                         <span class="keywordtype">int</span> face = computer.<a class="code" href="classbt_convex_hull_computer.html#c63efa14dad485f2210ac9f6a33bbd95">faces</a>[i];
<a name="l00202"></a>00202                                         <span class="comment">//printf("face=%d\n",face);</span>
<a name="l00203"></a>00203                                         <span class="keyword">const</span> btConvexHullComputer::Edge*  firstEdge = &amp;computer.<a class="code" href="classbt_convex_hull_computer.html#fd8c62200e928bf2db95ee77ed9dc887">edges</a>[face];
<a name="l00204"></a>00204                                         <span class="keyword">const</span> btConvexHullComputer::Edge*  edge = firstEdge-&gt;getNextEdgeOfFace();
<a name="l00205"></a>00205 
<a name="l00206"></a>00206                                         <span class="keywordtype">int</span> v0 = firstEdge-&gt;getSourceVertex();
<a name="l00207"></a>00207                                         <span class="keywordtype">int</span> v1 = firstEdge-&gt;getTargetVertex();
<a name="l00208"></a>00208                                         <span class="keywordflow">while</span> (edge!=firstEdge)
<a name="l00209"></a>00209                                         {
<a name="l00210"></a>00210                                                 <span class="keywordtype">int</span> v2 = edge-&gt;getTargetVertex();
<a name="l00211"></a>00211                                                 idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#3f0eec1b40109254182f0fe35f6308d0">drawTriangle</a>(computer.<a class="code" href="classbt_convex_hull_computer.html#44b13cded1cd7726d3f18c2f6f98c7cc">vertices</a>[v0],computer.<a class="code" href="classbt_convex_hull_computer.html#44b13cded1cd7726d3f18c2f6f98c7cc">vertices</a>[v1],computer.<a class="code" href="classbt_convex_hull_computer.html#44b13cded1cd7726d3f18c2f6f98c7cc">vertices</a>[v2],color,1);
<a name="l00212"></a>00212                                                 edge = edge-&gt;getNextEdgeOfFace();
<a name="l00213"></a>00213                                                 v0=v1;
<a name="l00214"></a>00214                                                 v1=v2;
<a name="l00215"></a>00215                                         };
<a name="l00216"></a>00216                                 }
<a name="l00217"></a>00217 <span class="preprocessor">#else</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span>
<a name="l00219"></a>00219                                 HullDesc                hdsc(QF_TRIANGLES,vertices.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>(),&amp;vertices[0]);
<a name="l00220"></a>00220                                 HullResult              hres;
<a name="l00221"></a>00221                                 <a class="code" href="class_hull_library.html">HullLibrary</a>             hlib;
<a name="l00222"></a>00222                                 hdsc.mMaxVertices=vertices.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>();
<a name="l00223"></a>00223                                 hlib.<a class="code" href="class_hull_library.html#28e5dc544a9d0f326f5b9e02dac656f0">CreateConvexHull</a>(hdsc,hres);
<a name="l00224"></a>00224                                 <span class="keyword">const</span> btVector3 center=average(hres.m_OutputVertices);
<a name="l00225"></a>00225                                 <span class="keyword">add</span>(hres.m_OutputVertices,-center);
<a name="l00226"></a>00226                                 mul(hres.m_OutputVertices,(btScalar)1);
<a name="l00227"></a>00227                                 <span class="keyword">add</span>(hres.m_OutputVertices,center);
<a name="l00228"></a>00228                                 <span class="keywordflow">for</span>(j=0;j&lt;(int)hres.mNumFaces;++j)
<a name="l00229"></a>00229                                 {
<a name="l00230"></a>00230                                         <span class="keyword">const</span> <span class="keywordtype">int</span> idx[]={hres.m_Indices[j*3+0],hres.m_Indices[j*3+1],hres.m_Indices[j*3+2]};
<a name="l00231"></a>00231                                         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#3f0eec1b40109254182f0fe35f6308d0">drawTriangle</a>(hres.m_OutputVertices[idx[0]],
<a name="l00232"></a>00232                                                 hres.m_OutputVertices[idx[1]],
<a name="l00233"></a>00233                                                 hres.m_OutputVertices[idx[2]],
<a name="l00234"></a>00234                                                 color,1);
<a name="l00235"></a>00235                                 }
<a name="l00236"></a>00236                                 hlib.<a class="code" href="class_hull_library.html#1694479ac11e270c9f8f13164c0f6dcf">ReleaseResult</a>(hres);
<a name="l00237"></a>00237 <span class="preprocessor">#endif</span>
<a name="l00238"></a>00238 <span class="preprocessor"></span>
<a name="l00239"></a>00239                         }
<a name="l00240"></a>00240                         <span class="comment">/* Velocities   */</span> 
<a name="l00241"></a>00241 <span class="preprocessor">#if 0</span>
<a name="l00242"></a>00242 <span class="preprocessor"></span>                        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;psb-&gt;<a class="code" href="classbt_soft_body.html#9579ec7fb7f43787cf4bc74eed279f48">m_clusters</a>[i].m_nodes.size();++j)
<a name="l00243"></a>00243                         {
<a name="l00244"></a>00244                                 <span class="keyword">const</span> btSoftBody::Cluster&amp;      c=psb-&gt;<a class="code" href="classbt_soft_body.html#9579ec7fb7f43787cf4bc74eed279f48">m_clusters</a>[i];
<a name="l00245"></a>00245                                 <span class="keyword">const</span> btVector3                         r=c.m_nodes[j]-&gt;m_x-c.m_com;
<a name="l00246"></a>00246                                 <span class="keyword">const</span> btVector3                         v=c.m_lv+btCross(c.m_av,r);
<a name="l00247"></a>00247                                 idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(c.m_nodes[j]-&gt;m_x,c.m_nodes[j]-&gt;m_x+v,btVector3(1,0,0));
<a name="l00248"></a>00248                         }
<a name="l00249"></a>00249 <span class="preprocessor">#endif</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span>                        <span class="comment">/* Frame                */</span> 
<a name="l00251"></a>00251         <span class="comment">//              btSoftBody::Cluster&amp; c=*psb-&gt;m_clusters[i];</span>
<a name="l00252"></a>00252         <span class="comment">//              idraw-&gt;drawLine(c.m_com,c.m_framexform*btVector3(10,0,0),btVector3(1,0,0));</span>
<a name="l00253"></a>00253         <span class="comment">//              idraw-&gt;drawLine(c.m_com,c.m_framexform*btVector3(0,10,0),btVector3(0,1,0));</span>
<a name="l00254"></a>00254         <span class="comment">//              idraw-&gt;drawLine(c.m_com,c.m_framexform*btVector3(0,0,10),btVector3(0,0,1));</span>
<a name="l00255"></a>00255                 }
<a name="l00256"></a>00256         }
<a name="l00257"></a>00257         <span class="keywordflow">else</span>
<a name="l00258"></a>00258         {
<a name="l00259"></a>00259                 <span class="comment">/* Nodes        */</span> 
<a name="l00260"></a>00260                 <span class="keywordflow">if</span>(0!=(drawflags&amp;fDrawFlags::Nodes))
<a name="l00261"></a>00261                 {
<a name="l00262"></a>00262                         <span class="keywordflow">for</span>(i=0;i&lt;psb-&gt;<a class="code" href="classbt_soft_body.html#d53c95f39d517c1b72db24f175e92fb5">m_nodes</a>.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>();++i)
<a name="l00263"></a>00263                         {
<a name="l00264"></a>00264                                 <span class="keyword">const</span> btSoftBody::Node&amp; n=psb-&gt;<a class="code" href="classbt_soft_body.html#d53c95f39d517c1b72db24f175e92fb5">m_nodes</a>[i];
<a name="l00265"></a>00265                                 <span class="keywordflow">if</span>(0==(n.m_material-&gt;m_flags&amp;btSoftBody::fMaterial::DebugDraw)) <span class="keywordflow">continue</span>;
<a name="l00266"></a>00266                                 idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(n.m_x-btVector3(scl,0,0),n.m_x+btVector3(scl,0,0),btVector3(1,0,0));
<a name="l00267"></a>00267                                 idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(n.m_x-btVector3(0,scl,0),n.m_x+btVector3(0,scl,0),btVector3(0,1,0));
<a name="l00268"></a>00268                                 idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(n.m_x-btVector3(0,0,scl),n.m_x+btVector3(0,0,scl),btVector3(0,0,1));
<a name="l00269"></a>00269                         }
<a name="l00270"></a>00270                 }
<a name="l00271"></a>00271                 <span class="comment">/* Links        */</span> 
<a name="l00272"></a>00272                 <span class="keywordflow">if</span>(0!=(drawflags&amp;fDrawFlags::Links))
<a name="l00273"></a>00273                 {
<a name="l00274"></a>00274                         <span class="keywordflow">for</span>(i=0;i&lt;psb-&gt;<a class="code" href="classbt_soft_body.html#b52f85beefd08470be24a0586832ff4e">m_links</a>.size();++i)
<a name="l00275"></a>00275                         {
<a name="l00276"></a>00276                                 <span class="keyword">const</span> btSoftBody::Link&amp; l=psb-&gt;<a class="code" href="classbt_soft_body.html#b52f85beefd08470be24a0586832ff4e">m_links</a>[i];
<a name="l00277"></a>00277                                 <span class="keywordflow">if</span>(0==(l.m_material-&gt;m_flags&amp;btSoftBody::fMaterial::DebugDraw)) <span class="keywordflow">continue</span>;
<a name="l00278"></a>00278                                 idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(l.m_n[0]-&gt;m_x,l.m_n[1]-&gt;m_x,lcolor);
<a name="l00279"></a>00279                         }
<a name="l00280"></a>00280                 }
<a name="l00281"></a>00281                 <span class="comment">/* Normals      */</span> 
<a name="l00282"></a>00282                 <span class="keywordflow">if</span>(0!=(drawflags&amp;fDrawFlags::Normals))
<a name="l00283"></a>00283                 {
<a name="l00284"></a>00284                         <span class="keywordflow">for</span>(i=0;i&lt;psb-&gt;<a class="code" href="classbt_soft_body.html#d53c95f39d517c1b72db24f175e92fb5">m_nodes</a>.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>();++i)
<a name="l00285"></a>00285                         {
<a name="l00286"></a>00286                                 <span class="keyword">const</span> btSoftBody::Node&amp; n=psb-&gt;<a class="code" href="classbt_soft_body.html#d53c95f39d517c1b72db24f175e92fb5">m_nodes</a>[i];
<a name="l00287"></a>00287                                 <span class="keywordflow">if</span>(0==(n.m_material-&gt;m_flags&amp;btSoftBody::fMaterial::DebugDraw)) <span class="keywordflow">continue</span>;
<a name="l00288"></a>00288                                 <span class="keyword">const</span> btVector3                 d=n.m_n*nscl;
<a name="l00289"></a>00289                                 idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(n.m_x,n.m_x+d,ncolor);
<a name="l00290"></a>00290                                 idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(n.m_x,n.m_x-d,ncolor*0.5);
<a name="l00291"></a>00291                         }
<a name="l00292"></a>00292                 }
<a name="l00293"></a>00293                 <span class="comment">/* Contacts     */</span> 
<a name="l00294"></a>00294                 <span class="keywordflow">if</span>(0!=(drawflags&amp;fDrawFlags::Contacts))
<a name="l00295"></a>00295                 {
<a name="l00296"></a>00296                         <span class="keyword">static</span> <span class="keyword">const</span> btVector3          <a class="code" href="group__gtc__quaternion.html#g5c243b588291c790bf1b5ec3f0f08d1b">axis</a>[]={btVector3(1,0,0),
<a name="l00297"></a>00297                                 btVector3(0,1,0),
<a name="l00298"></a>00298                                 btVector3(0,0,1)};
<a name="l00299"></a>00299                         <span class="keywordflow">for</span>(i=0;i&lt;psb-&gt;<a class="code" href="classbt_soft_body.html#8a6217d7ddb3dd99447c41a539e0cdc4">m_rcontacts</a>.size();++i)
<a name="l00300"></a>00300                         {               
<a name="l00301"></a>00301                                 <span class="keyword">const</span> btSoftBody::RContact&amp;     c=psb-&gt;<a class="code" href="classbt_soft_body.html#8a6217d7ddb3dd99447c41a539e0cdc4">m_rcontacts</a>[i];
<a name="l00302"></a>00302                                 <span class="keyword">const</span> btVector3                         o=      c.m_node-&gt;m_x-c.m_cti.m_normal*
<a name="l00303"></a>00303                                         (btDot(c.m_node-&gt;m_x,c.m_cti.m_normal)+c.m_cti.m_offset);
<a name="l00304"></a>00304                                 <span class="keyword">const</span> btVector3                         x=btCross(c.m_cti.m_normal,axis[c.m_cti.m_normal.minAxis()]).normalized();
<a name="l00305"></a>00305                                 <span class="keyword">const</span> btVector3                         y=btCross(x,c.m_cti.m_normal).normalized();
<a name="l00306"></a>00306                                 idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(o-x*nscl,o+x*nscl,ccolor);
<a name="l00307"></a>00307                                 idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(o-y*nscl,o+y*nscl,ccolor);
<a name="l00308"></a>00308                                 idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(o,o+c.m_cti.m_normal*nscl*3,btVector3(1,1,0));
<a name="l00309"></a>00309                         }
<a name="l00310"></a>00310                 }
<a name="l00311"></a>00311                 <span class="comment">/* Faces        */</span> 
<a name="l00312"></a>00312         <span class="keywordflow">if</span>(0!=(drawflags&amp;fDrawFlags::Faces))
<a name="l00313"></a>00313         {
<a name="l00314"></a>00314                 <span class="keyword">const</span> btScalar  scl=(btScalar)0.8;
<a name="l00315"></a>00315                 <span class="keyword">const</span> btScalar  alp=(btScalar)1;
<a name="l00316"></a>00316                 <span class="keyword">const</span> btVector3 col(0,(btScalar)0.7,0);
<a name="l00317"></a>00317                 <span class="keywordflow">for</span>(i=0;i&lt;psb-&gt;<a class="code" href="classbt_soft_body.html#76a8ea9e874b87a9dc51846cc24f3a4f">m_faces</a>.size();++i)
<a name="l00318"></a>00318                 {
<a name="l00319"></a>00319                         <span class="keyword">const</span> btSoftBody::Face&amp; f=psb-&gt;<a class="code" href="classbt_soft_body.html#76a8ea9e874b87a9dc51846cc24f3a4f">m_faces</a>[i];
<a name="l00320"></a>00320                         <span class="keywordflow">if</span>(0==(f.m_material-&gt;m_flags&amp;btSoftBody::fMaterial::DebugDraw)) <span class="keywordflow">continue</span>;
<a name="l00321"></a>00321                         <span class="keyword">const</span> btVector3                 x[]={f.m_n[0]-&gt;m_x,f.m_n[1]-&gt;m_x,f.m_n[2]-&gt;m_x};
<a name="l00322"></a>00322                         <span class="keyword">const</span> btVector3                 c=(x[0]+x[1]+x[2])/3;
<a name="l00323"></a>00323                         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#3f0eec1b40109254182f0fe35f6308d0">drawTriangle</a>((x[0]-c)*scl+c,
<a name="l00324"></a>00324                                 (x[1]-c)*scl+c,
<a name="l00325"></a>00325                                 (x[2]-c)*scl+c,
<a name="l00326"></a>00326                                 col,alp);
<a name="l00327"></a>00327                 }       
<a name="l00328"></a>00328         }
<a name="l00329"></a>00329         <span class="comment">/* Tetras       */</span> 
<a name="l00330"></a>00330         <span class="keywordflow">if</span>(0!=(drawflags&amp;fDrawFlags::Tetras))
<a name="l00331"></a>00331         {
<a name="l00332"></a>00332                 <span class="keyword">const</span> btScalar  scl=(btScalar)0.8;
<a name="l00333"></a>00333                 <span class="keyword">const</span> btScalar  alp=(btScalar)1;
<a name="l00334"></a>00334                 <span class="keyword">const</span> btVector3 col((btScalar)0.3,(btScalar)0.3,(btScalar)0.7);
<a name="l00335"></a>00335                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;psb-&gt;<a class="code" href="classbt_soft_body.html#5d67872e5c52a4d6cee4df5f752f9cfb">m_tetras</a>.size();++i)
<a name="l00336"></a>00336                 {
<a name="l00337"></a>00337                         <span class="keyword">const</span> btSoftBody::Tetra&amp;        t=psb-&gt;<a class="code" href="classbt_soft_body.html#5d67872e5c52a4d6cee4df5f752f9cfb">m_tetras</a>[i];
<a name="l00338"></a>00338                         <span class="keywordflow">if</span>(0==(t.m_material-&gt;m_flags&amp;btSoftBody::fMaterial::DebugDraw)) <span class="keywordflow">continue</span>;
<a name="l00339"></a>00339                         <span class="keyword">const</span> btVector3                         x[]={t.m_n[0]-&gt;m_x,t.m_n[1]-&gt;m_x,t.m_n[2]-&gt;m_x,t.m_n[3]-&gt;m_x};
<a name="l00340"></a>00340                         <span class="keyword">const</span> btVector3                         c=(x[0]+x[1]+x[2]+x[3])/4;
<a name="l00341"></a>00341                         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#3f0eec1b40109254182f0fe35f6308d0">drawTriangle</a>((x[0]-c)*scl+c,(x[1]-c)*scl+c,(x[2]-c)*scl+c,col,alp);
<a name="l00342"></a>00342                         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#3f0eec1b40109254182f0fe35f6308d0">drawTriangle</a>((x[0]-c)*scl+c,(x[1]-c)*scl+c,(x[3]-c)*scl+c,col,alp);
<a name="l00343"></a>00343                         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#3f0eec1b40109254182f0fe35f6308d0">drawTriangle</a>((x[1]-c)*scl+c,(x[2]-c)*scl+c,(x[3]-c)*scl+c,col,alp);
<a name="l00344"></a>00344                         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#3f0eec1b40109254182f0fe35f6308d0">drawTriangle</a>((x[2]-c)*scl+c,(x[0]-c)*scl+c,(x[3]-c)*scl+c,col,alp);
<a name="l00345"></a>00345                 }       
<a name="l00346"></a>00346         }
<a name="l00347"></a>00347         }
<a name="l00348"></a>00348         <span class="comment">/* Anchors      */</span> 
<a name="l00349"></a>00349         <span class="keywordflow">if</span>(0!=(drawflags&amp;fDrawFlags::Anchors))
<a name="l00350"></a>00350         {
<a name="l00351"></a>00351                 <span class="keywordflow">for</span>(i=0;i&lt;psb-&gt;<a class="code" href="classbt_soft_body.html#c92bf269338f8e02284edff1cb075f1c">m_anchors</a>.size();++i)
<a name="l00352"></a>00352                 {
<a name="l00353"></a>00353                         <span class="keyword">const</span> btSoftBody::Anchor&amp;       a=psb-&gt;<a class="code" href="classbt_soft_body.html#c92bf269338f8e02284edff1cb075f1c">m_anchors</a>[i];
<a name="l00354"></a>00354                         <span class="keyword">const</span> btVector3                         q=a.m_body-&gt;getWorldTransform()*a.m_local;
<a name="l00355"></a>00355                         drawVertex(idraw,a.m_node-&gt;m_x,0.25,btVector3(1,0,0));
<a name="l00356"></a>00356                         drawVertex(idraw,q,0.25,btVector3(0,1,0));
<a name="l00357"></a>00357                         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(a.m_node-&gt;m_x,q,btVector3(1,1,1));
<a name="l00358"></a>00358                 }
<a name="l00359"></a>00359                 <span class="keywordflow">for</span>(i=0;i&lt;psb-&gt;<a class="code" href="classbt_soft_body.html#d53c95f39d517c1b72db24f175e92fb5">m_nodes</a>.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>();++i)
<a name="l00360"></a>00360                 {
<a name="l00361"></a>00361                         <span class="keyword">const</span> btSoftBody::Node&amp; n=psb-&gt;<a class="code" href="classbt_soft_body.html#d53c95f39d517c1b72db24f175e92fb5">m_nodes</a>[i];              
<a name="l00362"></a>00362                         <span class="keywordflow">if</span>(0==(n.m_material-&gt;m_flags&amp;btSoftBody::fMaterial::DebugDraw)) <span class="keywordflow">continue</span>;
<a name="l00363"></a>00363                         <span class="keywordflow">if</span>(n.m_im&lt;=0)
<a name="l00364"></a>00364                         {
<a name="l00365"></a>00365                                 drawVertex(idraw,n.m_x,0.25,btVector3(1,0,0));
<a name="l00366"></a>00366                         }
<a name="l00367"></a>00367                 }
<a name="l00368"></a>00368         }
<a name="l00369"></a>00369         
<a name="l00370"></a>00370 
<a name="l00371"></a>00371         <span class="comment">/* Notes        */</span> 
<a name="l00372"></a>00372         <span class="keywordflow">if</span>(0!=(drawflags&amp;fDrawFlags::Notes))
<a name="l00373"></a>00373         {
<a name="l00374"></a>00374                 <span class="keywordflow">for</span>(i=0;i&lt;psb-&gt;<a class="code" href="classbt_soft_body.html#b2d4d22ffbeed6ae64366f94e1e72fa2">m_notes</a>.size();++i)
<a name="l00375"></a>00375                 {
<a name="l00376"></a>00376                         <span class="keyword">const</span> btSoftBody::Note&amp; n=psb-&gt;<a class="code" href="classbt_soft_body.html#b2d4d22ffbeed6ae64366f94e1e72fa2">m_notes</a>[i];
<a name="l00377"></a>00377                         btVector3                               p=n.m_offset;
<a name="l00378"></a>00378                         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;n.m_rank;++j)
<a name="l00379"></a>00379                         {
<a name="l00380"></a>00380                                 p+=n.m_nodes[j]-&gt;m_x*n.m_coords[j];
<a name="l00381"></a>00381                         }
<a name="l00382"></a>00382                         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#287102dad359ae7c0685ec527c54ea48">draw3dText</a>(p,n.m_text);
<a name="l00383"></a>00383                 }
<a name="l00384"></a>00384         }
<a name="l00385"></a>00385         <span class="comment">/* Node tree    */</span> 
<a name="l00386"></a>00386         <span class="keywordflow">if</span>(0!=(drawflags&amp;fDrawFlags::NodeTree))         DrawNodeTree(psb,idraw);
<a name="l00387"></a>00387         <span class="comment">/* Face tree    */</span> 
<a name="l00388"></a>00388         <span class="keywordflow">if</span>(0!=(drawflags&amp;fDrawFlags::FaceTree))         DrawFaceTree(psb,idraw);
<a name="l00389"></a>00389         <span class="comment">/* Cluster tree */</span> 
<a name="l00390"></a>00390         <span class="keywordflow">if</span>(0!=(drawflags&amp;fDrawFlags::ClusterTree))      DrawClusterTree(psb,idraw);
<a name="l00391"></a>00391         <span class="comment">/* Joints               */</span> 
<a name="l00392"></a>00392         <span class="keywordflow">if</span>(0!=(drawflags&amp;fDrawFlags::Joints))
<a name="l00393"></a>00393         {
<a name="l00394"></a>00394                 <span class="keywordflow">for</span>(i=0;i&lt;psb-&gt;<a class="code" href="classbt_soft_body.html#1c4a78e51ce702096f3db221cc2ae8a6">m_joints</a>.size();++i)
<a name="l00395"></a>00395                 {
<a name="l00396"></a>00396                         <span class="keyword">const</span> btSoftBody::Joint*        pj=psb-&gt;<a class="code" href="classbt_soft_body.html#1c4a78e51ce702096f3db221cc2ae8a6">m_joints</a>[i];
<a name="l00397"></a>00397                         <span class="keywordflow">switch</span>(pj-&gt;Type())
<a name="l00398"></a>00398                         {
<a name="l00399"></a>00399                         <span class="keywordflow">case</span>    btSoftBody::Joint::eType::Linear:
<a name="l00400"></a>00400                                 {
<a name="l00401"></a>00401                                         <span class="keyword">const</span> btSoftBody::LJoint*       pjl=(<span class="keyword">const</span> btSoftBody::LJoint*)pj;
<a name="l00402"></a>00402                                         <span class="keyword">const</span> btVector3 a0=pj-&gt;m_bodies[0].xform()*pjl-&gt;m_refs[0];
<a name="l00403"></a>00403                                         <span class="keyword">const</span> btVector3 a1=pj-&gt;m_bodies[1].xform()*pjl-&gt;m_refs[1];
<a name="l00404"></a>00404                                         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(pj-&gt;m_bodies[0].xform().getOrigin(),a0,btVector3(1,1,0));
<a name="l00405"></a>00405                                         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(pj-&gt;m_bodies[1].xform().getOrigin(),a1,btVector3(0,1,1));
<a name="l00406"></a>00406                                         drawVertex(idraw,a0,0.25,btVector3(1,1,0));
<a name="l00407"></a>00407                                         drawVertex(idraw,a1,0.25,btVector3(0,1,1));
<a name="l00408"></a>00408                                 }
<a name="l00409"></a>00409                                 <span class="keywordflow">break</span>;
<a name="l00410"></a>00410                         <span class="keywordflow">case</span>    btSoftBody::Joint::eType::Angular:
<a name="l00411"></a>00411                                 {
<a name="l00412"></a>00412                                         <span class="comment">//const btSoftBody::AJoint*     pja=(const btSoftBody::AJoint*)pj;</span>
<a name="l00413"></a>00413                                         <span class="keyword">const</span> btVector3 o0=pj-&gt;m_bodies[0].xform().getOrigin();
<a name="l00414"></a>00414                                         <span class="keyword">const</span> btVector3 o1=pj-&gt;m_bodies[1].xform().getOrigin();
<a name="l00415"></a>00415                                         <span class="keyword">const</span> btVector3 a0=pj-&gt;m_bodies[0].xform().getBasis()*pj-&gt;m_refs[0];
<a name="l00416"></a>00416                                         <span class="keyword">const</span> btVector3 a1=pj-&gt;m_bodies[1].xform().getBasis()*pj-&gt;m_refs[1];
<a name="l00417"></a>00417                                         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(o0,o0+a0*10,btVector3(1,1,0));
<a name="l00418"></a>00418                                         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(o0,o0+a1*10,btVector3(1,1,0));
<a name="l00419"></a>00419                                         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(o1,o1+a0*10,btVector3(0,1,1));
<a name="l00420"></a>00420                                         idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(o1,o1+a1*10,btVector3(0,1,1));
<a name="l00421"></a>00421                                         <span class="keywordflow">break</span>;
<a name="l00422"></a>00422                                 }
<a name="l00423"></a>00423                                 <span class="keywordflow">default</span>:
<a name="l00424"></a>00424                                 {
<a name="l00425"></a>00425                                 }
<a name="l00426"></a>00426                                         
<a name="l00427"></a>00427                         }               
<a name="l00428"></a>00428                 }
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430 }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432 <span class="comment">//</span>
<a name="l00433"></a>00433 <span class="keywordtype">void</span>                    btSoftBodyHelpers::DrawInfos(           <a class="code" href="classbt_soft_body.html">btSoftBody</a>* psb,
<a name="l00434"></a>00434                                                                                          <a class="code" href="classbt_i_debug_draw.html">btIDebugDraw</a>* idraw,
<a name="l00435"></a>00435                                                                                          <span class="keywordtype">bool</span> masses,
<a name="l00436"></a>00436                                                                                          <span class="keywordtype">bool</span> areas,
<a name="l00437"></a>00437                                                                                          <span class="keywordtype">bool</span> <span class="comment">/*stress*/</span>)
<a name="l00438"></a>00438 {
<a name="l00439"></a>00439         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;psb-&gt;<a class="code" href="classbt_soft_body.html#d53c95f39d517c1b72db24f175e92fb5">m_nodes</a>.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>();++i)
<a name="l00440"></a>00440         {
<a name="l00441"></a>00441                 <span class="keyword">const</span> btSoftBody::Node&amp; n=psb-&gt;<a class="code" href="classbt_soft_body.html#d53c95f39d517c1b72db24f175e92fb5">m_nodes</a>[i];
<a name="l00442"></a>00442                 <span class="keywordtype">char</span>                                    text[2048]={0};
<a name="l00443"></a>00443                 <span class="keywordtype">char</span>                                    buff[1024];
<a name="l00444"></a>00444                 <span class="keywordflow">if</span>(masses)
<a name="l00445"></a>00445                 {
<a name="l00446"></a>00446                         sprintf(buff,<span class="stringliteral">" M(%.2f)"</span>,1/n.m_im);
<a name="l00447"></a>00447                         strcat(text,buff);
<a name="l00448"></a>00448                 }
<a name="l00449"></a>00449                 <span class="keywordflow">if</span>(areas)
<a name="l00450"></a>00450                 {
<a name="l00451"></a>00451                         sprintf(buff,<span class="stringliteral">" A(%.2f)"</span>,n.m_area);
<a name="l00452"></a>00452                         strcat(text,buff);
<a name="l00453"></a>00453                 }
<a name="l00454"></a>00454                 <span class="keywordflow">if</span>(text[0]) idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#287102dad359ae7c0685ec527c54ea48">draw3dText</a>(n.m_x,text);
<a name="l00455"></a>00455         }
<a name="l00456"></a>00456 }
<a name="l00457"></a>00457 
<a name="l00458"></a>00458 <span class="comment">//</span>
<a name="l00459"></a>00459 <span class="keywordtype">void</span>                    btSoftBodyHelpers::DrawNodeTree(        <a class="code" href="classbt_soft_body.html">btSoftBody</a>* psb,
<a name="l00460"></a>00460                                                                                                 <a class="code" href="classbt_i_debug_draw.html">btIDebugDraw</a>* idraw,
<a name="l00461"></a>00461                                                                                                 <span class="keywordtype">int</span> mindepth,
<a name="l00462"></a>00462                                                                                                 <span class="keywordtype">int</span> maxdepth)
<a name="l00463"></a>00463 {
<a name="l00464"></a>00464         drawTree(idraw,psb-&gt;<a class="code" href="classbt_soft_body.html#ff100eec6044f78bbc4f7e5ccf4619d3">m_ndbvt</a>.<a class="code" href="structbt_dbvt.html#c79cacfc8471aa681ee8756ca9d5683a">m_root</a>,0,btVector3(1,0,1),btVector3(1,1,1),mindepth,maxdepth);
<a name="l00465"></a>00465 }
<a name="l00466"></a>00466 
<a name="l00467"></a>00467 <span class="comment">//</span>
<a name="l00468"></a>00468 <span class="keywordtype">void</span>                    btSoftBodyHelpers::DrawFaceTree(        <a class="code" href="classbt_soft_body.html">btSoftBody</a>* psb,
<a name="l00469"></a>00469                                                                                                 <a class="code" href="classbt_i_debug_draw.html">btIDebugDraw</a>* idraw,
<a name="l00470"></a>00470                                                                                                 <span class="keywordtype">int</span> mindepth,
<a name="l00471"></a>00471                                                                                                 <span class="keywordtype">int</span> maxdepth)
<a name="l00472"></a>00472 {
<a name="l00473"></a>00473         drawTree(idraw,psb-&gt;<a class="code" href="classbt_soft_body.html#b4ca8f3ddef99e2068818d6fabbad321">m_fdbvt</a>.<a class="code" href="structbt_dbvt.html#c79cacfc8471aa681ee8756ca9d5683a">m_root</a>,0,btVector3(0,1,0),btVector3(1,0,0),mindepth,maxdepth);
<a name="l00474"></a>00474 }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476 <span class="comment">//</span>
<a name="l00477"></a>00477 <span class="keywordtype">void</span>                    btSoftBodyHelpers::DrawClusterTree(     <a class="code" href="classbt_soft_body.html">btSoftBody</a>* psb,
<a name="l00478"></a>00478                                                                                                    <a class="code" href="classbt_i_debug_draw.html">btIDebugDraw</a>* idraw,
<a name="l00479"></a>00479                                                                                                    <span class="keywordtype">int</span> mindepth,
<a name="l00480"></a>00480                                                                                                    <span class="keywordtype">int</span> maxdepth)
<a name="l00481"></a>00481 {
<a name="l00482"></a>00482         drawTree(idraw,psb-&gt;<a class="code" href="classbt_soft_body.html#108b2be76b7647b2138d99e99b3bbdb0">m_cdbvt</a>.<a class="code" href="structbt_dbvt.html#c79cacfc8471aa681ee8756ca9d5683a">m_root</a>,0,btVector3(0,1,1),btVector3(1,0,0),mindepth,maxdepth);
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485 
<a name="l00486"></a>00486 <span class="comment">//The btSoftBody object from the BulletSDK includes an array of Nodes and Links. These links appear</span>
<a name="l00487"></a>00487 <span class="comment">// to be first set up to connect a node to between 5 and 6 of its neighbors [480 links], </span>
<a name="l00488"></a>00488 <span class="comment">//and then to the rest of the nodes after the execution of the Floyd-Warshall graph algorithm </span>
<a name="l00489"></a>00489 <span class="comment">//[another 930 links]. </span>
<a name="l00490"></a>00490 <span class="comment">//The way the links are stored by default, we have a number of cases where adjacent links share a node in common</span>
<a name="l00491"></a>00491 <span class="comment">// - this leads to the creation of a data dependency through memory. </span>
<a name="l00492"></a>00492 <span class="comment">//The PSolve_Links() function reads and writes nodes as it iterates over each link. </span>
<a name="l00493"></a>00493 <span class="comment">//So, we now have the possibility of a data dependency between iteration X </span>
<a name="l00494"></a>00494 <span class="comment">//that processes link L with iteration X+1 that processes link L+1 </span>
<a name="l00495"></a>00495 <span class="comment">//because L and L+1 have one node in common, and iteration X updates the positions of that node, </span>
<a name="l00496"></a>00496 <span class="comment">//and iteration X+1 reads in the position of that shared node.</span>
<a name="l00497"></a>00497 <span class="comment">//</span>
<a name="l00498"></a>00498 <span class="comment">//Such a memory dependency limits the ability of a modern CPU to speculate beyond </span>
<a name="l00499"></a>00499 <span class="comment">//a certain point because it has to respect a possible dependency </span>
<a name="l00500"></a>00500 <span class="comment">//- this prevents the CPU from making full use of its out-of-order resources. </span>
<a name="l00501"></a>00501 <span class="comment">//If we re-order the links such that we minimize the cases where a link L and L+1 share a common node, </span>
<a name="l00502"></a>00502 <span class="comment">//we create a temporal gap between when the node position is written, </span>
<a name="l00503"></a>00503 <span class="comment">//and when it is subsequently read. This in turn allows the CPU to continue execution without </span>
<a name="l00504"></a>00504 <span class="comment">//risking a dependency violation. Such a reordering would result in significant speedups on </span>
<a name="l00505"></a>00505 <span class="comment">//modern CPUs with lots of execution resources. </span>
<a name="l00506"></a>00506 <span class="comment">//In our testing, we see it have a tremendous impact not only on the A7, </span>
<a name="l00507"></a>00507 <span class="comment">//but also on all x86 cores that ship with modern Macs. </span>
<a name="l00508"></a>00508 <span class="comment">//The attached source file includes a single function (ReoptimizeLinkOrder) which can be called on a </span>
<a name="l00509"></a>00509 <span class="comment">//btSoftBody object in the solveConstraints() function before the actual solver is invoked, </span>
<a name="l00510"></a>00510 <span class="comment">//or right after generateBendingConstraints() once we have all 1410 links.</span>
<a name="l00511"></a>00511 
<a name="l00512"></a>00512 
<a name="l00513"></a>00513 <span class="comment">//===================================================================</span>
<a name="l00514"></a>00514 <span class="comment">//</span>
<a name="l00515"></a>00515 <span class="comment">//</span>
<a name="l00516"></a>00516 <span class="comment">// This function takes in a list of interdependent Links and tries </span>
<a name="l00517"></a>00517 <span class="comment">// to maximize the distance between calculation</span>
<a name="l00518"></a>00518 <span class="comment">// of dependent links.  This increases the amount of parallelism that can</span>
<a name="l00519"></a>00519 <span class="comment">// be exploited by out-of-order instruction processors with large but</span>
<a name="l00520"></a>00520 <span class="comment">// (inevitably) finite instruction windows.</span>
<a name="l00521"></a>00521 <span class="comment">//</span>
<a name="l00522"></a>00522 <span class="comment">//===================================================================</span>
<a name="l00523"></a>00523 
<a name="l00524"></a>00524 <span class="comment">// A small structure to track lists of dependent link calculations</span>
<a name="l00525"></a>00525 <span class="keyword">class </span>LinkDeps_t {
<a name="l00526"></a>00526         <span class="keyword">public</span>:
<a name="l00527"></a>00527         <span class="keywordtype">int</span> value;                      <span class="comment">// A link calculation that is dependent on this one</span>
<a name="l00528"></a>00528                 <span class="comment">// Positive values = "input A" while negative values = "input B"</span>
<a name="l00529"></a>00529         LinkDeps_t *next;       <span class="comment">// Next dependence in the list</span>
<a name="l00530"></a>00530 };
<a name="l00531"></a>00531 <span class="keyword">typedef</span> LinkDeps_t *LinkDepsPtr_t;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533 <span class="comment">// Dependency list constants</span>
<a name="l00534"></a>00534 <span class="preprocessor">#define REOP_NOT_DEPENDENT      -1</span>
<a name="l00535"></a>00535 <span class="preprocessor"></span><span class="preprocessor">#define REOP_NODE_COMPLETE      -2      // Must be less than REOP_NOT_DEPENDENT</span>
<a name="l00536"></a>00536 <span class="preprocessor"></span>
<a name="l00537"></a>00537 
<a name="l00538"></a>00538 <span class="keywordtype">void</span> btSoftBodyHelpers::ReoptimizeLinkOrder(<a class="code" href="classbt_soft_body.html">btSoftBody</a> *psb <span class="comment">/* This can be replaced by a btSoftBody pointer */</span>)
<a name="l00539"></a>00539 {
<a name="l00540"></a>00540         <span class="keywordtype">int</span> i, nLinks=psb-&gt;<a class="code" href="classbt_soft_body.html#b52f85beefd08470be24a0586832ff4e">m_links</a>.size(), nNodes=psb-&gt;<a class="code" href="classbt_soft_body.html#d53c95f39d517c1b72db24f175e92fb5">m_nodes</a>.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>();
<a name="l00541"></a>00541         btSoftBody::Link *lr;
<a name="l00542"></a>00542         <span class="keywordtype">int</span> ar, br;
<a name="l00543"></a>00543         btSoftBody::Node *node0 = &amp;(psb-&gt;<a class="code" href="classbt_soft_body.html#d53c95f39d517c1b72db24f175e92fb5">m_nodes</a>[0]);
<a name="l00544"></a>00544         btSoftBody::Node *node1 = &amp;(psb-&gt;<a class="code" href="classbt_soft_body.html#d53c95f39d517c1b72db24f175e92fb5">m_nodes</a>[1]);
<a name="l00545"></a>00545         LinkDepsPtr_t linkDep;
<a name="l00546"></a>00546         <span class="keywordtype">int</span> readyListHead, readyListTail, linkNum, linkDepFrees, depLink;
<a name="l00547"></a>00547         
<a name="l00548"></a>00548         <span class="comment">// Allocate temporary buffers</span>
<a name="l00549"></a>00549         <span class="keywordtype">int</span> *nodeWrittenAt = <span class="keyword">new</span> <span class="keywordtype">int</span>[nNodes+1]; <span class="comment">// What link calculation produced this node's current values?</span>
<a name="l00550"></a>00550         <span class="keywordtype">int</span> *linkDepA = <span class="keyword">new</span> <span class="keywordtype">int</span>[nLinks];                        <span class="comment">// Link calculation input is dependent upon prior calculation #N</span>
<a name="l00551"></a>00551         <span class="keywordtype">int</span> *linkDepB = <span class="keyword">new</span> <span class="keywordtype">int</span>[nLinks];
<a name="l00552"></a>00552         <span class="keywordtype">int</span> *readyList = <span class="keyword">new</span> <span class="keywordtype">int</span>[nLinks];               <span class="comment">// List of ready-to-process link calculations (# of links, maximum)</span>
<a name="l00553"></a>00553         LinkDeps_t *linkDepFreeList = <span class="keyword">new</span> LinkDeps_t[2*nLinks];         <span class="comment">// Dependent-on-me list elements (2x# of links, maximum)</span>
<a name="l00554"></a>00554         LinkDepsPtr_t *linkDepListStarts = <span class="keyword">new</span> LinkDepsPtr_t[nLinks];   <span class="comment">// Start nodes of dependent-on-me lists, one for each link</span>
<a name="l00555"></a>00555                 
<a name="l00556"></a>00556         <span class="comment">// Copy the original, unsorted links to a side buffer</span>
<a name="l00557"></a>00557         btSoftBody::Link *linkBuffer = <span class="keyword">new</span> btSoftBody::Link[nLinks];
<a name="l00558"></a>00558         memcpy(linkBuffer, &amp;(psb-&gt;<a class="code" href="classbt_soft_body.html#b52f85beefd08470be24a0586832ff4e">m_links</a>[0]), <span class="keyword">sizeof</span>(btSoftBody::Link)*nLinks);
<a name="l00559"></a>00559 
<a name="l00560"></a>00560         <span class="comment">// Clear out the node setup and ready list</span>
<a name="l00561"></a>00561         <span class="keywordflow">for</span> (i=0; i &lt; nNodes+1; i++) {
<a name="l00562"></a>00562                 nodeWrittenAt[i] = REOP_NOT_DEPENDENT;
<a name="l00563"></a>00563         }
<a name="l00564"></a>00564         <span class="keywordflow">for</span> (i=0; i &lt; nLinks; i++) {
<a name="l00565"></a>00565                 linkDepListStarts[i] = NULL;
<a name="l00566"></a>00566         }
<a name="l00567"></a>00567         readyListHead = readyListTail = linkDepFrees = 0;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569         <span class="comment">// Initial link analysis to set up data structures</span>
<a name="l00570"></a>00570         <span class="keywordflow">for</span> (i=0; i &lt; nLinks; i++) {
<a name="l00571"></a>00571         
<a name="l00572"></a>00572                 <span class="comment">// Note which prior link calculations we are dependent upon &amp; build up dependence lists</span>
<a name="l00573"></a>00573                 lr = &amp;(psb-&gt;<a class="code" href="classbt_soft_body.html#b52f85beefd08470be24a0586832ff4e">m_links</a>[i]);
<a name="l00574"></a>00574                 ar = (lr-&gt;m_n[0] - node0)/(node1 - node0);
<a name="l00575"></a>00575                 br = (lr-&gt;m_n[1] - node0)/(node1 - node0);
<a name="l00576"></a>00576                 <span class="keywordflow">if</span> (nodeWrittenAt[ar] &gt; REOP_NOT_DEPENDENT) {
<a name="l00577"></a>00577                         linkDepA[i] = nodeWrittenAt[ar];
<a name="l00578"></a>00578                         linkDep = &amp;linkDepFreeList[linkDepFrees++];
<a name="l00579"></a>00579                         linkDep-&gt;value = i;
<a name="l00580"></a>00580                         linkDep-&gt;next = linkDepListStarts[nodeWrittenAt[ar]];
<a name="l00581"></a>00581                         linkDepListStarts[nodeWrittenAt[ar]] = linkDep;
<a name="l00582"></a>00582                 } <span class="keywordflow">else</span> {
<a name="l00583"></a>00583                         linkDepA[i] = REOP_NOT_DEPENDENT;
<a name="l00584"></a>00584                 }
<a name="l00585"></a>00585                 <span class="keywordflow">if</span> (nodeWrittenAt[br] &gt; REOP_NOT_DEPENDENT) {
<a name="l00586"></a>00586                         linkDepB[i] = nodeWrittenAt[br];
<a name="l00587"></a>00587                         linkDep = &amp;linkDepFreeList[linkDepFrees++];
<a name="l00588"></a>00588                         linkDep-&gt;value = -(i+1);
<a name="l00589"></a>00589                         linkDep-&gt;next = linkDepListStarts[nodeWrittenAt[br]];
<a name="l00590"></a>00590                         linkDepListStarts[nodeWrittenAt[br]] = linkDep;
<a name="l00591"></a>00591                 } <span class="keywordflow">else</span> {
<a name="l00592"></a>00592                         linkDepB[i] = REOP_NOT_DEPENDENT;
<a name="l00593"></a>00593                 }
<a name="l00594"></a>00594                 
<a name="l00595"></a>00595                 <span class="comment">// Add this link to the initial ready list, if it is not dependent on any other links</span>
<a name="l00596"></a>00596                 <span class="keywordflow">if</span> ((linkDepA[i] == REOP_NOT_DEPENDENT) &amp;&amp; (linkDepB[i] == REOP_NOT_DEPENDENT)) {
<a name="l00597"></a>00597                         readyList[readyListTail++] = i;
<a name="l00598"></a>00598                         linkDepA[i] = linkDepB[i] = REOP_NODE_COMPLETE; <span class="comment">// Probably not needed now</span>
<a name="l00599"></a>00599                 }
<a name="l00600"></a>00600                 
<a name="l00601"></a>00601                 <span class="comment">// Update the nodes to mark which ones are calculated by this link</span>
<a name="l00602"></a>00602                 nodeWrittenAt[ar] = nodeWrittenAt[br] = i;
<a name="l00603"></a>00603         }
<a name="l00604"></a>00604         
<a name="l00605"></a>00605         <span class="comment">// Process the ready list and create the sorted list of links</span>
<a name="l00606"></a>00606         <span class="comment">// -- By treating the ready list as a queue, we maximize the distance between any</span>
<a name="l00607"></a>00607         <span class="comment">//    inter-dependent node calculations</span>
<a name="l00608"></a>00608         <span class="comment">// -- All other (non-related) nodes in the ready list will automatically be inserted</span>
<a name="l00609"></a>00609         <span class="comment">//    in between each set of inter-dependent link calculations by this loop</span>
<a name="l00610"></a>00610         i = 0;
<a name="l00611"></a>00611         <span class="keywordflow">while</span> (readyListHead != readyListTail) {
<a name="l00612"></a>00612                 <span class="comment">// Use ready list to select the next link to process</span>
<a name="l00613"></a>00613                 linkNum = readyList[readyListHead++];
<a name="l00614"></a>00614                 <span class="comment">// Copy the next-to-calculate link back into the original link array</span>
<a name="l00615"></a>00615                 psb-&gt;<a class="code" href="classbt_soft_body.html#b52f85beefd08470be24a0586832ff4e">m_links</a>[i++] = linkBuffer[linkNum];
<a name="l00616"></a>00616 
<a name="l00617"></a>00617                 <span class="comment">// Free up any link inputs that are dependent on this one</span>
<a name="l00618"></a>00618                 linkDep = linkDepListStarts[linkNum];
<a name="l00619"></a>00619                 <span class="keywordflow">while</span> (linkDep) {
<a name="l00620"></a>00620                         depLink = linkDep-&gt;value;
<a name="l00621"></a>00621                         <span class="keywordflow">if</span> (depLink &gt;= 0) {
<a name="l00622"></a>00622                                 linkDepA[depLink] = REOP_NOT_DEPENDENT;
<a name="l00623"></a>00623                         } <span class="keywordflow">else</span> {
<a name="l00624"></a>00624                                 depLink = -depLink - 1;
<a name="l00625"></a>00625                                 linkDepB[depLink] = REOP_NOT_DEPENDENT;
<a name="l00626"></a>00626                         }
<a name="l00627"></a>00627                         <span class="comment">// Add this dependent link calculation to the ready list if *both* inputs are clear</span>
<a name="l00628"></a>00628                         <span class="keywordflow">if</span> ((linkDepA[depLink] == REOP_NOT_DEPENDENT) &amp;&amp; (linkDepB[depLink] == REOP_NOT_DEPENDENT)) {
<a name="l00629"></a>00629                                 readyList[readyListTail++] = depLink;
<a name="l00630"></a>00630                                 linkDepA[depLink] = linkDepB[depLink] = REOP_NODE_COMPLETE;     <span class="comment">// Probably not needed now</span>
<a name="l00631"></a>00631                         }
<a name="l00632"></a>00632                         linkDep = linkDep-&gt;next;
<a name="l00633"></a>00633                 }
<a name="l00634"></a>00634         }
<a name="l00635"></a>00635 
<a name="l00636"></a>00636         <span class="comment">// Delete the temporary buffers</span>
<a name="l00637"></a>00637         <span class="keyword">delete</span> [] nodeWrittenAt;
<a name="l00638"></a>00638         <span class="keyword">delete</span> [] linkDepA;
<a name="l00639"></a>00639         <span class="keyword">delete</span> [] linkDepB;
<a name="l00640"></a>00640         <span class="keyword">delete</span> [] readyList;
<a name="l00641"></a>00641         <span class="keyword">delete</span> [] linkDepFreeList;
<a name="l00642"></a>00642         <span class="keyword">delete</span> [] linkDepListStarts;
<a name="l00643"></a>00643         <span class="keyword">delete</span> [] linkBuffer;
<a name="l00644"></a>00644 }
<a name="l00645"></a>00645 
<a name="l00646"></a>00646 
<a name="l00647"></a>00647 <span class="comment">//</span>
<a name="l00648"></a>00648 <span class="keywordtype">void</span>                    btSoftBodyHelpers::DrawFrame(           <a class="code" href="classbt_soft_body.html">btSoftBody</a>* psb,
<a name="l00649"></a>00649                                                                                          <a class="code" href="classbt_i_debug_draw.html">btIDebugDraw</a>* idraw)
<a name="l00650"></a>00650 {
<a name="l00651"></a>00651         <span class="keywordflow">if</span>(psb-&gt;<a class="code" href="classbt_soft_body.html#3c1d3c3e9f60e3d97f08245a82fa0ed3">m_pose</a>.m_bframe)
<a name="l00652"></a>00652         {
<a name="l00653"></a>00653                 <span class="keyword">static</span> <span class="keyword">const</span> btScalar   ascl=10;
<a name="l00654"></a>00654                 <span class="keyword">static</span> <span class="keyword">const</span> btScalar   nscl=(btScalar)0.1;
<a name="l00655"></a>00655                 <span class="keyword">const</span> btVector3                 com=psb-&gt;<a class="code" href="classbt_soft_body.html#3c1d3c3e9f60e3d97f08245a82fa0ed3">m_pose</a>.m_com;
<a name="l00656"></a>00656                 <span class="keyword">const</span> btMatrix3x3               trs=psb-&gt;<a class="code" href="classbt_soft_body.html#3c1d3c3e9f60e3d97f08245a82fa0ed3">m_pose</a>.m_rot*psb-&gt;<a class="code" href="classbt_soft_body.html#3c1d3c3e9f60e3d97f08245a82fa0ed3">m_pose</a>.m_scl;
<a name="l00657"></a>00657                 <span class="keyword">const</span> btVector3                 Xaxis=(trs*btVector3(1,0,0)).normalized();
<a name="l00658"></a>00658                 <span class="keyword">const</span> btVector3                 Yaxis=(trs*btVector3(0,1,0)).normalized();
<a name="l00659"></a>00659                 <span class="keyword">const</span> btVector3                 Zaxis=(trs*btVector3(0,0,1)).normalized();
<a name="l00660"></a>00660                 idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(com,com+Xaxis*ascl,btVector3(1,0,0));
<a name="l00661"></a>00661                 idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(com,com+Yaxis*ascl,btVector3(0,1,0));
<a name="l00662"></a>00662                 idraw-&gt;<a class="code" href="classbt_i_debug_draw.html#07b08e255ab4607ab5aeb24399332aff">drawLine</a>(com,com+Zaxis*ascl,btVector3(0,0,1));
<a name="l00663"></a>00663                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;psb-&gt;<a class="code" href="classbt_soft_body.html#3c1d3c3e9f60e3d97f08245a82fa0ed3">m_pose</a>.m_pos.size();++i)
<a name="l00664"></a>00664                 {
<a name="l00665"></a>00665                         <span class="keyword">const</span> btVector3 x=com+trs*psb-&gt;<a class="code" href="classbt_soft_body.html#3c1d3c3e9f60e3d97f08245a82fa0ed3">m_pose</a>.m_pos[i];
<a name="l00666"></a>00666                         drawVertex(idraw,x,nscl,btVector3(1,0,1));
<a name="l00667"></a>00667                 }
<a name="l00668"></a>00668         }
<a name="l00669"></a>00669 }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671 <span class="comment">//</span>
<a name="l00672"></a>00672 <a class="code" href="classbt_soft_body.html">btSoftBody</a>*             btSoftBodyHelpers::CreateRope(  btSoftBodyWorldInfo&amp; worldInfo, <span class="keyword">const</span> btVector3&amp; from,
<a name="l00673"></a>00673                                                                                           <span class="keyword">const</span> btVector3&amp; to,
<a name="l00674"></a>00674                                                                                           <span class="keywordtype">int</span> res,
<a name="l00675"></a>00675                                                                                           <span class="keywordtype">int</span> fixeds)
<a name="l00676"></a>00676 {
<a name="l00677"></a>00677         <span class="comment">/* Create nodes */</span> 
<a name="l00678"></a>00678         <span class="keyword">const</span> <span class="keywordtype">int</span>               r=res+2;
<a name="l00679"></a>00679         btVector3*              x=<span class="keyword">new</span> btVector3[r];
<a name="l00680"></a>00680         btScalar*               m=<span class="keyword">new</span> btScalar[r];
<a name="l00681"></a>00681         <span class="keywordtype">int</span> i;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683         <span class="keywordflow">for</span>(i=0;i&lt;r;++i)
<a name="l00684"></a>00684         {
<a name="l00685"></a>00685                 <span class="keyword">const</span> btScalar  t=i/(btScalar)(r-1);
<a name="l00686"></a>00686                 x[i]=<a class="code" href="group__gtc__dual__quaternion.html#gfbbdf3bd28dbfe656af3d86b9c7e0cd3">lerp</a>(from,to,t);
<a name="l00687"></a>00687                 m[i]=1;
<a name="l00688"></a>00688         }
<a name="l00689"></a>00689         <a class="code" href="classbt_soft_body.html">btSoftBody</a>*             psb= <span class="keyword">new</span> <a class="code" href="classbt_soft_body.html">btSoftBody</a>(&amp;worldInfo,r,x,m);
<a name="l00690"></a>00690         <span class="keywordflow">if</span>(fixeds&amp;1) psb-&gt;<a class="code" href="classbt_soft_body.html#1aa16f724cd3f5e8431f3fec07d75b60">setMass</a>(0,0);
<a name="l00691"></a>00691         <span class="keywordflow">if</span>(fixeds&amp;2) psb-&gt;<a class="code" href="classbt_soft_body.html#1aa16f724cd3f5e8431f3fec07d75b60">setMass</a>(r-1,0);
<a name="l00692"></a>00692         <span class="keyword">delete</span>[] x;
<a name="l00693"></a>00693         <span class="keyword">delete</span>[] m;
<a name="l00694"></a>00694         <span class="comment">/* Create links */</span> 
<a name="l00695"></a>00695         <span class="keywordflow">for</span>(i=1;i&lt;r;++i)
<a name="l00696"></a>00696         {
<a name="l00697"></a>00697                 psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(i-1,i);
<a name="l00698"></a>00698         }
<a name="l00699"></a>00699         <span class="comment">/* Finished             */</span> 
<a name="l00700"></a>00700         <span class="keywordflow">return</span>(psb);
<a name="l00701"></a>00701 }
<a name="l00702"></a>00702 
<a name="l00703"></a>00703 <span class="comment">//</span>
<a name="l00704"></a>00704 <a class="code" href="classbt_soft_body.html">btSoftBody</a>*             btSoftBodyHelpers::CreatePatch(btSoftBodyWorldInfo&amp; worldInfo,<span class="keyword">const</span> btVector3&amp; corner00,
<a name="l00705"></a>00705                                                                                            <span class="keyword">const</span> btVector3&amp; corner10,
<a name="l00706"></a>00706                                                                                            <span class="keyword">const</span> btVector3&amp; corner01,
<a name="l00707"></a>00707                                                                                            <span class="keyword">const</span> btVector3&amp; corner11,
<a name="l00708"></a>00708                                                                                            <span class="keywordtype">int</span> resx,
<a name="l00709"></a>00709                                                                                            <span class="keywordtype">int</span> resy,
<a name="l00710"></a>00710                                                                                            <span class="keywordtype">int</span> fixeds,
<a name="l00711"></a>00711                                                                                            <span class="keywordtype">bool</span> gendiags)
<a name="l00712"></a>00712 {
<a name="l00713"></a>00713 <span class="preprocessor">#define IDX(_x_,_y_)    ((_y_)*rx+(_x_))</span>
<a name="l00714"></a>00714 <span class="preprocessor"></span>        <span class="comment">/* Create nodes */</span> 
<a name="l00715"></a>00715         <span class="keywordflow">if</span>((resx&lt;2)||(resy&lt;2)) <span class="keywordflow">return</span>(0);
<a name="l00716"></a>00716         <span class="keyword">const</span> <span class="keywordtype">int</span>       rx=resx;
<a name="l00717"></a>00717         <span class="keyword">const</span> <span class="keywordtype">int</span>       ry=resy;
<a name="l00718"></a>00718         <span class="keyword">const</span> <span class="keywordtype">int</span>       tot=rx*ry;
<a name="l00719"></a>00719         btVector3*      x=<span class="keyword">new</span> btVector3[tot];
<a name="l00720"></a>00720         btScalar*       m=<span class="keyword">new</span> btScalar[tot];
<a name="l00721"></a>00721         <span class="keywordtype">int</span> iy;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723         <span class="keywordflow">for</span>(iy=0;iy&lt;ry;++iy)
<a name="l00724"></a>00724         {
<a name="l00725"></a>00725                 <span class="keyword">const</span> btScalar  ty=iy/(btScalar)(ry-1);
<a name="l00726"></a>00726                 <span class="keyword">const</span> btVector3 py0=<a class="code" href="group__gtc__dual__quaternion.html#gfbbdf3bd28dbfe656af3d86b9c7e0cd3">lerp</a>(corner00,corner01,ty);
<a name="l00727"></a>00727                 <span class="keyword">const</span> btVector3 py1=<a class="code" href="group__gtc__dual__quaternion.html#gfbbdf3bd28dbfe656af3d86b9c7e0cd3">lerp</a>(corner10,corner11,ty);
<a name="l00728"></a>00728                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0;ix&lt;rx;++ix)
<a name="l00729"></a>00729                 {
<a name="l00730"></a>00730                         <span class="keyword">const</span> btScalar  tx=ix/(btScalar)(rx-1);
<a name="l00731"></a>00731                         x[IDX(ix,iy)]=<a class="code" href="group__gtc__dual__quaternion.html#gfbbdf3bd28dbfe656af3d86b9c7e0cd3">lerp</a>(py0,py1,tx);
<a name="l00732"></a>00732                         m[IDX(ix,iy)]=1;
<a name="l00733"></a>00733                 }
<a name="l00734"></a>00734         }
<a name="l00735"></a>00735         <a class="code" href="classbt_soft_body.html">btSoftBody</a>*             psb=<span class="keyword">new</span> <a class="code" href="classbt_soft_body.html">btSoftBody</a>(&amp;worldInfo,tot,x,m);
<a name="l00736"></a>00736         <span class="keywordflow">if</span>(fixeds&amp;1)    psb-&gt;<a class="code" href="classbt_soft_body.html#1aa16f724cd3f5e8431f3fec07d75b60">setMass</a>(IDX(0,0),0);
<a name="l00737"></a>00737         <span class="keywordflow">if</span>(fixeds&amp;2)    psb-&gt;<a class="code" href="classbt_soft_body.html#1aa16f724cd3f5e8431f3fec07d75b60">setMass</a>(IDX(rx-1,0),0);
<a name="l00738"></a>00738         <span class="keywordflow">if</span>(fixeds&amp;4)    psb-&gt;<a class="code" href="classbt_soft_body.html#1aa16f724cd3f5e8431f3fec07d75b60">setMass</a>(IDX(0,ry-1),0);
<a name="l00739"></a>00739         <span class="keywordflow">if</span>(fixeds&amp;8)    psb-&gt;<a class="code" href="classbt_soft_body.html#1aa16f724cd3f5e8431f3fec07d75b60">setMass</a>(IDX(rx-1,ry-1),0);
<a name="l00740"></a>00740         <span class="keyword">delete</span>[] x;
<a name="l00741"></a>00741         <span class="keyword">delete</span>[] m;
<a name="l00742"></a>00742         <span class="comment">/* Create links and faces */</span> 
<a name="l00743"></a>00743         <span class="keywordflow">for</span>(iy=0;iy&lt;ry;++iy)
<a name="l00744"></a>00744         {
<a name="l00745"></a>00745                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0;ix&lt;rx;++ix)
<a name="l00746"></a>00746                 {
<a name="l00747"></a>00747                         <span class="keyword">const</span> <span class="keywordtype">int</span>       idx=IDX(ix,iy);
<a name="l00748"></a>00748                         <span class="keyword">const</span> <span class="keywordtype">bool</span>      mdx=(ix+1)&lt;rx;
<a name="l00749"></a>00749                         <span class="keyword">const</span> <span class="keywordtype">bool</span>      mdy=(iy+1)&lt;ry;
<a name="l00750"></a>00750                         <span class="keywordflow">if</span>(mdx) psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(idx,IDX(ix+1,iy));
<a name="l00751"></a>00751                         <span class="keywordflow">if</span>(mdy) psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(idx,IDX(ix,iy+1));
<a name="l00752"></a>00752                         <span class="keywordflow">if</span>(mdx&amp;&amp;mdy)
<a name="l00753"></a>00753                         {
<a name="l00754"></a>00754                                 <span class="keywordflow">if</span>((ix+iy)&amp;1)
<a name="l00755"></a>00755                                 {
<a name="l00756"></a>00756                                         psb-&gt;<a class="code" href="classbt_soft_body.html#1a89dadf0b4a8d9553d5e2263c034b07">appendFace</a>(IDX(ix,iy),IDX(ix+1,iy),IDX(ix+1,iy+1));
<a name="l00757"></a>00757                                         psb-&gt;<a class="code" href="classbt_soft_body.html#1a89dadf0b4a8d9553d5e2263c034b07">appendFace</a>(IDX(ix,iy),IDX(ix+1,iy+1),IDX(ix,iy+1));
<a name="l00758"></a>00758                                         <span class="keywordflow">if</span>(gendiags)
<a name="l00759"></a>00759                                         {
<a name="l00760"></a>00760                                                 psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(IDX(ix,iy),IDX(ix+1,iy+1));
<a name="l00761"></a>00761                                         }
<a name="l00762"></a>00762                                 }
<a name="l00763"></a>00763                                 <span class="keywordflow">else</span>
<a name="l00764"></a>00764                                 {
<a name="l00765"></a>00765                                         psb-&gt;<a class="code" href="classbt_soft_body.html#1a89dadf0b4a8d9553d5e2263c034b07">appendFace</a>(IDX(ix,iy+1),IDX(ix,iy),IDX(ix+1,iy));
<a name="l00766"></a>00766                                         psb-&gt;<a class="code" href="classbt_soft_body.html#1a89dadf0b4a8d9553d5e2263c034b07">appendFace</a>(IDX(ix,iy+1),IDX(ix+1,iy),IDX(ix+1,iy+1));
<a name="l00767"></a>00767                                         <span class="keywordflow">if</span>(gendiags)
<a name="l00768"></a>00768                                         {
<a name="l00769"></a>00769                                                 psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(IDX(ix+1,iy),IDX(ix,iy+1));
<a name="l00770"></a>00770                                         }
<a name="l00771"></a>00771                                 }
<a name="l00772"></a>00772                         }
<a name="l00773"></a>00773                 }
<a name="l00774"></a>00774         }
<a name="l00775"></a>00775         <span class="comment">/* Finished             */</span> 
<a name="l00776"></a>00776 <span class="preprocessor">#undef IDX</span>
<a name="l00777"></a>00777 <span class="preprocessor"></span>        <span class="keywordflow">return</span>(psb);
<a name="l00778"></a>00778 }
<a name="l00779"></a>00779 
<a name="l00780"></a>00780 <span class="comment">//</span>
<a name="l00781"></a>00781 <a class="code" href="classbt_soft_body.html">btSoftBody</a>*             btSoftBodyHelpers::CreatePatchUV(btSoftBodyWorldInfo&amp; worldInfo,
<a name="l00782"></a>00782                                                                                                  <span class="keyword">const</span> btVector3&amp; corner00,
<a name="l00783"></a>00783                                                                                                  <span class="keyword">const</span> btVector3&amp; corner10,
<a name="l00784"></a>00784                                                                                                  <span class="keyword">const</span> btVector3&amp; corner01,
<a name="l00785"></a>00785                                                                                                  <span class="keyword">const</span> btVector3&amp; corner11,
<a name="l00786"></a>00786                                                                                                  <span class="keywordtype">int</span> resx,
<a name="l00787"></a>00787                                                                                                  <span class="keywordtype">int</span> resy,
<a name="l00788"></a>00788                                                                                                  <span class="keywordtype">int</span> fixeds,
<a name="l00789"></a>00789                                                                                                  <span class="keywordtype">bool</span> gendiags,
<a name="l00790"></a>00790                                                                                                  <span class="keywordtype">float</span>* tex_coords)
<a name="l00791"></a>00791 {
<a name="l00792"></a>00792 
<a name="l00793"></a>00793         <span class="comment">/*</span>
<a name="l00794"></a>00794 <span class="comment">        *</span>
<a name="l00795"></a>00795 <span class="comment">        *  corners:</span>
<a name="l00796"></a>00796 <span class="comment">        *</span>
<a name="l00797"></a>00797 <span class="comment">        *  [0][0]     corner00 ------- corner01   [resx][0]</span>
<a name="l00798"></a>00798 <span class="comment">        *                |                |</span>
<a name="l00799"></a>00799 <span class="comment">        *                |                |</span>
<a name="l00800"></a>00800 <span class="comment">        *  [0][resy]  corner10 -------- corner11  [resx][resy]</span>
<a name="l00801"></a>00801 <span class="comment">        *</span>
<a name="l00802"></a>00802 <span class="comment">        *</span>
<a name="l00803"></a>00803 <span class="comment">        *</span>
<a name="l00804"></a>00804 <span class="comment">        *</span>
<a name="l00805"></a>00805 <span class="comment">        *</span>
<a name="l00806"></a>00806 <span class="comment">        *</span>
<a name="l00807"></a>00807 <span class="comment">        *   "fixedgs" map:</span>
<a name="l00808"></a>00808 <span class="comment">        *</span>
<a name="l00809"></a>00809 <span class="comment">        *  corner00     --&gt;   +1</span>
<a name="l00810"></a>00810 <span class="comment">        *  corner01     --&gt;   +2</span>
<a name="l00811"></a>00811 <span class="comment">        *  corner10     --&gt;   +4</span>
<a name="l00812"></a>00812 <span class="comment">        *  corner11     --&gt;   +8</span>
<a name="l00813"></a>00813 <span class="comment">        *  upper middle --&gt;  +16</span>
<a name="l00814"></a>00814 <span class="comment">        *  left middle  --&gt;  +32</span>
<a name="l00815"></a>00815 <span class="comment">        *  right middle --&gt;  +64</span>
<a name="l00816"></a>00816 <span class="comment">        *  lower middle --&gt; +128</span>
<a name="l00817"></a>00817 <span class="comment">        *  center       --&gt; +256</span>
<a name="l00818"></a>00818 <span class="comment">        *</span>
<a name="l00819"></a>00819 <span class="comment">        *</span>
<a name="l00820"></a>00820 <span class="comment">        *   tex_coords size   (resx-1)*(resy-1)*12</span>
<a name="l00821"></a>00821 <span class="comment">        *</span>
<a name="l00822"></a>00822 <span class="comment">        *</span>
<a name="l00823"></a>00823 <span class="comment">        *</span>
<a name="l00824"></a>00824 <span class="comment">        *     SINGLE QUAD INTERNALS</span>
<a name="l00825"></a>00825 <span class="comment">        *</span>
<a name="l00826"></a>00826 <span class="comment">        *  1) btSoftBody's nodes and links,</span>
<a name="l00827"></a>00827 <span class="comment">        *     diagonal link is optional ("gendiags")</span>
<a name="l00828"></a>00828 <span class="comment">        *</span>
<a name="l00829"></a>00829 <span class="comment">        *</span>
<a name="l00830"></a>00830 <span class="comment">        *    node00 ------ node01</span>
<a name="l00831"></a>00831 <span class="comment">        *      | .              </span>
<a name="l00832"></a>00832 <span class="comment">        *      |   .            </span>
<a name="l00833"></a>00833 <span class="comment">        *      |     .          </span>
<a name="l00834"></a>00834 <span class="comment">        *      |       .        </span>
<a name="l00835"></a>00835 <span class="comment">        *      |         .      </span>
<a name="l00836"></a>00836 <span class="comment">        *    node10        node11</span>
<a name="l00837"></a>00837 <span class="comment">        *</span>
<a name="l00838"></a>00838 <span class="comment">        *</span>
<a name="l00839"></a>00839 <span class="comment">        *</span>
<a name="l00840"></a>00840 <span class="comment">        *   2) Faces:</span>
<a name="l00841"></a>00841 <span class="comment">        *      two triangles,</span>
<a name="l00842"></a>00842 <span class="comment">        *      UV Coordinates (hier example for single quad)</span>
<a name="l00843"></a>00843 <span class="comment">        *      </span>
<a name="l00844"></a>00844 <span class="comment">        *     (0,1)          (0,1)  (1,1)</span>
<a name="l00845"></a>00845 <span class="comment">        *     1 |\            3 \-----| 2</span>
<a name="l00846"></a>00846 <span class="comment">        *       | \              \    |</span>
<a name="l00847"></a>00847 <span class="comment">        *       |  \              \   |</span>
<a name="l00848"></a>00848 <span class="comment">        *       |   \              \  |</span>
<a name="l00849"></a>00849 <span class="comment">        *       |    \              \ |</span>
<a name="l00850"></a>00850 <span class="comment">        *     2 |-----\ 3            \| 1</span>
<a name="l00851"></a>00851 <span class="comment">        *     (0,0)    (1,0)       (1,0)</span>
<a name="l00852"></a>00852 <span class="comment">        *</span>
<a name="l00853"></a>00853 <span class="comment">        *</span>
<a name="l00854"></a>00854 <span class="comment">        *</span>
<a name="l00855"></a>00855 <span class="comment">        *</span>
<a name="l00856"></a>00856 <span class="comment">        *</span>
<a name="l00857"></a>00857 <span class="comment">        *</span>
<a name="l00858"></a>00858 <span class="comment">        */</span>
<a name="l00859"></a>00859 
<a name="l00860"></a>00860 <span class="preprocessor">#define IDX(_x_,_y_)    ((_y_)*rx+(_x_))</span>
<a name="l00861"></a>00861 <span class="preprocessor"></span>        <span class="comment">/* Create nodes         */</span> 
<a name="l00862"></a>00862         <span class="keywordflow">if</span>((resx&lt;2)||(resy&lt;2)) <span class="keywordflow">return</span>(0);
<a name="l00863"></a>00863         <span class="keyword">const</span> <span class="keywordtype">int</span>       rx=resx;
<a name="l00864"></a>00864         <span class="keyword">const</span> <span class="keywordtype">int</span>       ry=resy;
<a name="l00865"></a>00865         <span class="keyword">const</span> <span class="keywordtype">int</span>       tot=rx*ry;
<a name="l00866"></a>00866         btVector3*      x=<span class="keyword">new</span> btVector3[tot];
<a name="l00867"></a>00867         btScalar*       m=<span class="keyword">new</span> btScalar[tot];
<a name="l00868"></a>00868 
<a name="l00869"></a>00869         <span class="keywordtype">int</span> iy;
<a name="l00870"></a>00870 
<a name="l00871"></a>00871         <span class="keywordflow">for</span>(iy=0;iy&lt;ry;++iy)
<a name="l00872"></a>00872         {
<a name="l00873"></a>00873                 <span class="keyword">const</span> btScalar  ty=iy/(btScalar)(ry-1);
<a name="l00874"></a>00874                 <span class="keyword">const</span> btVector3 py0=<a class="code" href="group__gtc__dual__quaternion.html#gfbbdf3bd28dbfe656af3d86b9c7e0cd3">lerp</a>(corner00,corner01,ty);
<a name="l00875"></a>00875                 <span class="keyword">const</span> btVector3 py1=<a class="code" href="group__gtc__dual__quaternion.html#gfbbdf3bd28dbfe656af3d86b9c7e0cd3">lerp</a>(corner10,corner11,ty);
<a name="l00876"></a>00876                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0;ix&lt;rx;++ix)
<a name="l00877"></a>00877                 {
<a name="l00878"></a>00878                         <span class="keyword">const</span> btScalar  tx=ix/(btScalar)(rx-1);
<a name="l00879"></a>00879                         x[IDX(ix,iy)]=<a class="code" href="group__gtc__dual__quaternion.html#gfbbdf3bd28dbfe656af3d86b9c7e0cd3">lerp</a>(py0,py1,tx);
<a name="l00880"></a>00880                         m[IDX(ix,iy)]=1;
<a name="l00881"></a>00881                 }
<a name="l00882"></a>00882         }
<a name="l00883"></a>00883         <a class="code" href="classbt_soft_body.html">btSoftBody</a>*     psb=<span class="keyword">new</span> <a class="code" href="classbt_soft_body.html">btSoftBody</a>(&amp;worldInfo,tot,x,m);
<a name="l00884"></a>00884         <span class="keywordflow">if</span>(fixeds&amp;1)            psb-&gt;<a class="code" href="classbt_soft_body.html#1aa16f724cd3f5e8431f3fec07d75b60">setMass</a>(IDX(0,0),0);
<a name="l00885"></a>00885         <span class="keywordflow">if</span>(fixeds&amp;2)            psb-&gt;<a class="code" href="classbt_soft_body.html#1aa16f724cd3f5e8431f3fec07d75b60">setMass</a>(IDX(rx-1,0),0);
<a name="l00886"></a>00886         <span class="keywordflow">if</span>(fixeds&amp;4)            psb-&gt;<a class="code" href="classbt_soft_body.html#1aa16f724cd3f5e8431f3fec07d75b60">setMass</a>(IDX(0,ry-1),0);
<a name="l00887"></a>00887         <span class="keywordflow">if</span>(fixeds&amp;8)            psb-&gt;<a class="code" href="classbt_soft_body.html#1aa16f724cd3f5e8431f3fec07d75b60">setMass</a>(IDX(rx-1,ry-1),0);
<a name="l00888"></a>00888         <span class="keywordflow">if</span>(fixeds&amp;16)           psb-&gt;<a class="code" href="classbt_soft_body.html#1aa16f724cd3f5e8431f3fec07d75b60">setMass</a>(IDX((rx-1)/2,0),0);
<a name="l00889"></a>00889         <span class="keywordflow">if</span>(fixeds&amp;32)           psb-&gt;<a class="code" href="classbt_soft_body.html#1aa16f724cd3f5e8431f3fec07d75b60">setMass</a>(IDX(0,(ry-1)/2),0);
<a name="l00890"></a>00890         <span class="keywordflow">if</span>(fixeds&amp;64)           psb-&gt;<a class="code" href="classbt_soft_body.html#1aa16f724cd3f5e8431f3fec07d75b60">setMass</a>(IDX(rx-1,(ry-1)/2),0);
<a name="l00891"></a>00891         <span class="keywordflow">if</span>(fixeds&amp;128)          psb-&gt;<a class="code" href="classbt_soft_body.html#1aa16f724cd3f5e8431f3fec07d75b60">setMass</a>(IDX((rx-1)/2,ry-1),0);
<a name="l00892"></a>00892         <span class="keywordflow">if</span>(fixeds&amp;256)          psb-&gt;<a class="code" href="classbt_soft_body.html#1aa16f724cd3f5e8431f3fec07d75b60">setMass</a>(IDX((rx-1)/2,(ry-1)/2),0);
<a name="l00893"></a>00893         <span class="keyword">delete</span>[] x;
<a name="l00894"></a>00894         <span class="keyword">delete</span>[] m;
<a name="l00895"></a>00895 
<a name="l00896"></a>00896 
<a name="l00897"></a>00897         <span class="keywordtype">int</span> z = 0;
<a name="l00898"></a>00898         <span class="comment">/* Create links and faces       */</span> 
<a name="l00899"></a>00899         <span class="keywordflow">for</span>(iy=0;iy&lt;ry;++iy)
<a name="l00900"></a>00900         {
<a name="l00901"></a>00901                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0;ix&lt;rx;++ix)
<a name="l00902"></a>00902                 {
<a name="l00903"></a>00903                         <span class="keyword">const</span> <span class="keywordtype">bool</span>      mdx=(ix+1)&lt;rx;
<a name="l00904"></a>00904                         <span class="keyword">const</span> <span class="keywordtype">bool</span>      mdy=(iy+1)&lt;ry;
<a name="l00905"></a>00905 
<a name="l00906"></a>00906                         <span class="keywordtype">int</span> node00=IDX(ix,iy);
<a name="l00907"></a>00907                         <span class="keywordtype">int</span> node01=IDX(ix+1,iy);
<a name="l00908"></a>00908                         <span class="keywordtype">int</span> node10=IDX(ix,iy+1);
<a name="l00909"></a>00909                         <span class="keywordtype">int</span> node11=IDX(ix+1,iy+1);
<a name="l00910"></a>00910 
<a name="l00911"></a>00911                         <span class="keywordflow">if</span>(mdx) psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(node00,node01);
<a name="l00912"></a>00912                         <span class="keywordflow">if</span>(mdy) psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(node00,node10);
<a name="l00913"></a>00913                         <span class="keywordflow">if</span>(mdx&amp;&amp;mdy)
<a name="l00914"></a>00914                         {
<a name="l00915"></a>00915                                 psb-&gt;<a class="code" href="classbt_soft_body.html#1a89dadf0b4a8d9553d5e2263c034b07">appendFace</a>(node00,node10,node11);
<a name="l00916"></a>00916                                 <span class="keywordflow">if</span> (tex_coords) {
<a name="l00917"></a>00917                                         tex_coords[z+0]=CalculateUV(resx,resy,ix,iy,0);
<a name="l00918"></a>00918                                         tex_coords[z+1]=CalculateUV(resx,resy,ix,iy,1);
<a name="l00919"></a>00919                                         tex_coords[z+2]=CalculateUV(resx,resy,ix,iy,0);
<a name="l00920"></a>00920                                         tex_coords[z+3]=CalculateUV(resx,resy,ix,iy,2);
<a name="l00921"></a>00921                                         tex_coords[z+4]=CalculateUV(resx,resy,ix,iy,3);
<a name="l00922"></a>00922                                         tex_coords[z+5]=CalculateUV(resx,resy,ix,iy,2);
<a name="l00923"></a>00923                                 }
<a name="l00924"></a>00924                                 psb-&gt;<a class="code" href="classbt_soft_body.html#1a89dadf0b4a8d9553d5e2263c034b07">appendFace</a>(node11,node01,node00);
<a name="l00925"></a>00925                                 <span class="keywordflow">if</span> (tex_coords) {
<a name="l00926"></a>00926                                         tex_coords[z+6 ]=CalculateUV(resx,resy,ix,iy,3);
<a name="l00927"></a>00927                                         tex_coords[z+7 ]=CalculateUV(resx,resy,ix,iy,2);
<a name="l00928"></a>00928                                         tex_coords[z+8 ]=CalculateUV(resx,resy,ix,iy,3);
<a name="l00929"></a>00929                                         tex_coords[z+9 ]=CalculateUV(resx,resy,ix,iy,1);
<a name="l00930"></a>00930                                         tex_coords[z+10]=CalculateUV(resx,resy,ix,iy,0);
<a name="l00931"></a>00931                                         tex_coords[z+11]=CalculateUV(resx,resy,ix,iy,1);
<a name="l00932"></a>00932                                 }
<a name="l00933"></a>00933                                 <span class="keywordflow">if</span> (gendiags) psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(node00,node11);
<a name="l00934"></a>00934                                 z += 12;
<a name="l00935"></a>00935                         }
<a name="l00936"></a>00936                 }
<a name="l00937"></a>00937         }
<a name="l00938"></a>00938         <span class="comment">/* Finished     */</span> 
<a name="l00939"></a>00939 <span class="preprocessor">#undef IDX</span>
<a name="l00940"></a>00940 <span class="preprocessor"></span>        <span class="keywordflow">return</span>(psb);
<a name="l00941"></a>00941 }
<a name="l00942"></a>00942 
<a name="l00943"></a>00943 <span class="keywordtype">float</span>   btSoftBodyHelpers::CalculateUV(<span class="keywordtype">int</span> resx,<span class="keywordtype">int</span> resy,<span class="keywordtype">int</span> ix,<span class="keywordtype">int</span> iy,<span class="keywordtype">int</span> <span class="keywordtype">id</span>)
<a name="l00944"></a>00944 {
<a name="l00945"></a>00945 
<a name="l00946"></a>00946         <span class="comment">/*</span>
<a name="l00947"></a>00947 <span class="comment">        *</span>
<a name="l00948"></a>00948 <span class="comment">        *</span>
<a name="l00949"></a>00949 <span class="comment">        *    node00 --- node01</span>
<a name="l00950"></a>00950 <span class="comment">        *      |          |</span>
<a name="l00951"></a>00951 <span class="comment">        *    node10 --- node11</span>
<a name="l00952"></a>00952 <span class="comment">        *</span>
<a name="l00953"></a>00953 <span class="comment">        *</span>
<a name="l00954"></a>00954 <span class="comment">        *   ID map:</span>
<a name="l00955"></a>00955 <span class="comment">        *</span>
<a name="l00956"></a>00956 <span class="comment">        *   node00 s --&gt; 0</span>
<a name="l00957"></a>00957 <span class="comment">        *   node00 t --&gt; 1</span>
<a name="l00958"></a>00958 <span class="comment">        *</span>
<a name="l00959"></a>00959 <span class="comment">        *   node01 s --&gt; 3</span>
<a name="l00960"></a>00960 <span class="comment">        *   node01 t --&gt; 1</span>
<a name="l00961"></a>00961 <span class="comment">        *</span>
<a name="l00962"></a>00962 <span class="comment">        *   node10 s --&gt; 0</span>
<a name="l00963"></a>00963 <span class="comment">        *   node10 t --&gt; 2</span>
<a name="l00964"></a>00964 <span class="comment">        *</span>
<a name="l00965"></a>00965 <span class="comment">        *   node11 s --&gt; 3</span>
<a name="l00966"></a>00966 <span class="comment">        *   node11 t --&gt; 2</span>
<a name="l00967"></a>00967 <span class="comment">        *</span>
<a name="l00968"></a>00968 <span class="comment">        *</span>
<a name="l00969"></a>00969 <span class="comment">        */</span>
<a name="l00970"></a>00970 
<a name="l00971"></a>00971         <span class="keywordtype">float</span> tc=0.0f;
<a name="l00972"></a>00972         <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == 0) {
<a name="l00973"></a>00973                 tc = (1.0f/((resx-1))*ix);
<a name="l00974"></a>00974         }
<a name="l00975"></a>00975         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span>==1) {
<a name="l00976"></a>00976                 tc = (1.0f/((resy-1))*(resy-1-iy));
<a name="l00977"></a>00977         }
<a name="l00978"></a>00978         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span>==2) {
<a name="l00979"></a>00979                 tc = (1.0f/((resy-1))*(resy-1-iy-1));
<a name="l00980"></a>00980         }
<a name="l00981"></a>00981         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span>==3) {
<a name="l00982"></a>00982                 tc = (1.0f/((resx-1))*(ix+1));
<a name="l00983"></a>00983         }
<a name="l00984"></a>00984         <span class="keywordflow">return</span> tc;
<a name="l00985"></a>00985 }
<a name="l00986"></a>00986 <span class="comment">//</span>
<a name="l00987"></a>00987 <a class="code" href="classbt_soft_body.html">btSoftBody</a>*             btSoftBodyHelpers::CreateEllipsoid(btSoftBodyWorldInfo&amp; worldInfo,<span class="keyword">const</span> btVector3&amp; center,
<a name="l00988"></a>00988                                                                                                    <span class="keyword">const</span> btVector3&amp; radius,
<a name="l00989"></a>00989                                                                                                    <span class="keywordtype">int</span> res)
<a name="l00990"></a>00990 {
<a name="l00991"></a>00991         <span class="keyword">struct  </span>Hammersley
<a name="l00992"></a>00992         {
<a name="l00993"></a>00993                 <span class="keyword">static</span> <span class="keywordtype">void</span>     Generate(btVector3* x,<span class="keywordtype">int</span> n)
<a name="l00994"></a>00994                 {
<a name="l00995"></a>00995                         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;n;i++)
<a name="l00996"></a>00996                         {
<a name="l00997"></a>00997                                 btScalar        p=0.5,t=0;
<a name="l00998"></a>00998                                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=i;j;p*=0.5,j&gt;&gt;=1) <span class="keywordflow">if</span>(j&amp;1) t+=p;
<a name="l00999"></a>00999                                 btScalar        w=2*t-1;
<a name="l01000"></a>01000                                 btScalar        a=(SIMD_PI+2*i*SIMD_PI)/n;
<a name="l01001"></a>01001                                 btScalar        s=btSqrt(1-w*w);
<a name="l01002"></a>01002                                 *x++=btVector3(s*btCos(a),s*btSin(a),w);
<a name="l01003"></a>01003                         }
<a name="l01004"></a>01004                 }
<a name="l01005"></a>01005         };
<a name="l01006"></a>01006         <a class="code" href="classbt_aligned_object_array.html">btAlignedObjectArray&lt;btVector3&gt;</a> vtx;
<a name="l01007"></a>01007         vtx.<a class="code" href="classbt_aligned_object_array.html#6a48cd9cb91d0cfa50ee1c70ef485190">resize</a>(3+res);
<a name="l01008"></a>01008         Hammersley::Generate(&amp;vtx[0],vtx.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>());
<a name="l01009"></a>01009         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;vtx.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>();++i)
<a name="l01010"></a>01010         {
<a name="l01011"></a>01011                 vtx[i]=vtx[i]*radius+center;
<a name="l01012"></a>01012         }
<a name="l01013"></a>01013         <span class="keywordflow">return</span>(CreateFromConvexHull(worldInfo,&amp;vtx[0],vtx.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>()));
<a name="l01014"></a>01014 }
<a name="l01015"></a>01015 
<a name="l01016"></a>01016 
<a name="l01017"></a>01017 
<a name="l01018"></a>01018 <span class="comment">//</span>
<a name="l01019"></a>01019 <a class="code" href="classbt_soft_body.html">btSoftBody</a>*             btSoftBodyHelpers::CreateFromTriMesh(btSoftBodyWorldInfo&amp; worldInfo,<span class="keyword">const</span> btScalar*     vertices,
<a name="l01020"></a>01020                                                                                                          <span class="keyword">const</span> <span class="keywordtype">int</span>* triangles,
<a name="l01021"></a>01021                                                                                                          <span class="keywordtype">int</span> ntriangles, <span class="keywordtype">bool</span> randomizeConstraints)
<a name="l01022"></a>01022 {
<a name="l01023"></a>01023         <span class="keywordtype">int</span>             maxidx=0;
<a name="l01024"></a>01024         <span class="keywordtype">int</span> i,j,ni;
<a name="l01025"></a>01025 
<a name="l01026"></a>01026         <span class="keywordflow">for</span>(i=0,ni=ntriangles*3;i&lt;ni;++i)
<a name="l01027"></a>01027         {
<a name="l01028"></a>01028                 maxidx=btMax(triangles[i],maxidx);
<a name="l01029"></a>01029         }
<a name="l01030"></a>01030         ++maxidx;
<a name="l01031"></a>01031         <a class="code" href="classbt_aligned_object_array.html">btAlignedObjectArray&lt;bool&gt;</a>              chks;
<a name="l01032"></a>01032         <a class="code" href="classbt_aligned_object_array.html">btAlignedObjectArray&lt;btVector3&gt;</a> vtx;
<a name="l01033"></a>01033         chks.<a class="code" href="classbt_aligned_object_array.html#6a48cd9cb91d0cfa50ee1c70ef485190">resize</a>(maxidx*maxidx,<span class="keyword">false</span>);
<a name="l01034"></a>01034         vtx.<a class="code" href="classbt_aligned_object_array.html#6a48cd9cb91d0cfa50ee1c70ef485190">resize</a>(maxidx);
<a name="l01035"></a>01035         <span class="keywordflow">for</span>(i=0,j=0,ni=maxidx*3;i&lt;ni;++j,i+=3)
<a name="l01036"></a>01036         {
<a name="l01037"></a>01037                 vtx[j]=btVector3(vertices[i],vertices[i+1],vertices[i+2]);
<a name="l01038"></a>01038         }
<a name="l01039"></a>01039         <a class="code" href="classbt_soft_body.html">btSoftBody</a>*             psb=<span class="keyword">new</span> <a class="code" href="classbt_soft_body.html">btSoftBody</a>(&amp;worldInfo,vtx.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>(),&amp;vtx[0],0);
<a name="l01040"></a>01040         <span class="keywordflow">for</span>( i=0,ni=ntriangles*3;i&lt;ni;i+=3)
<a name="l01041"></a>01041         {
<a name="l01042"></a>01042                 <span class="keyword">const</span> <span class="keywordtype">int</span> idx[]={triangles[i],triangles[i+1],triangles[i+2]};
<a name="l01043"></a>01043 <span class="preprocessor">#define IDX(_x_,_y_) ((_y_)*maxidx+(_x_))</span>
<a name="l01044"></a>01044 <span class="preprocessor"></span>                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=2,k=0;k&lt;3;j=k++)
<a name="l01045"></a>01045                 {
<a name="l01046"></a>01046                         <span class="keywordflow">if</span>(!chks[IDX(idx[j],idx[k])])
<a name="l01047"></a>01047                         {
<a name="l01048"></a>01048                                 chks[IDX(idx[j],idx[k])]=<span class="keyword">true</span>;
<a name="l01049"></a>01049                                 chks[IDX(idx[k],idx[j])]=<span class="keyword">true</span>;
<a name="l01050"></a>01050                                 psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(idx[j],idx[k]);
<a name="l01051"></a>01051                         }
<a name="l01052"></a>01052                 }
<a name="l01053"></a>01053 <span class="preprocessor">#undef IDX</span>
<a name="l01054"></a>01054 <span class="preprocessor"></span>                psb-&gt;<a class="code" href="classbt_soft_body.html#1a89dadf0b4a8d9553d5e2263c034b07">appendFace</a>(idx[0],idx[1],idx[2]);
<a name="l01055"></a>01055         }
<a name="l01056"></a>01056 
<a name="l01057"></a>01057         <span class="keywordflow">if</span> (randomizeConstraints)
<a name="l01058"></a>01058         {
<a name="l01059"></a>01059                 psb-&gt;<a class="code" href="classbt_soft_body.html#cc984ed7b1ae0c8520d474f4ba3e053f">randomizeConstraints</a>();
<a name="l01060"></a>01060         }
<a name="l01061"></a>01061 
<a name="l01062"></a>01062         <span class="keywordflow">return</span>(psb);
<a name="l01063"></a>01063 }
<a name="l01064"></a>01064 
<a name="l01065"></a>01065 <span class="comment">//</span>
<a name="l01066"></a>01066 <a class="code" href="classbt_soft_body.html">btSoftBody</a>*             btSoftBodyHelpers::CreateFromConvexHull(btSoftBodyWorldInfo&amp; worldInfo, <span class="keyword">const</span> btVector3* vertices,
<a name="l01067"></a>01067                                                                                                                 <span class="keywordtype">int</span> nvertices, <span class="keywordtype">bool</span> randomizeConstraints)
<a name="l01068"></a>01068 {
<a name="l01069"></a>01069         HullDesc                hdsc(QF_TRIANGLES,nvertices,vertices);
<a name="l01070"></a>01070         HullResult              hres;
<a name="l01071"></a>01071         <a class="code" href="class_hull_library.html">HullLibrary</a>             hlib;<span class="comment">/*??*/</span> 
<a name="l01072"></a>01072         hdsc.mMaxVertices=nvertices;
<a name="l01073"></a>01073         hlib.<a class="code" href="class_hull_library.html#28e5dc544a9d0f326f5b9e02dac656f0">CreateConvexHull</a>(hdsc,hres);
<a name="l01074"></a>01074         <a class="code" href="classbt_soft_body.html">btSoftBody</a>*             psb=<span class="keyword">new</span> <a class="code" href="classbt_soft_body.html">btSoftBody</a>(&amp;worldInfo,(<span class="keywordtype">int</span>)hres.mNumOutputVertices,
<a name="l01075"></a>01075                 &amp;hres.m_OutputVertices[0],0);
<a name="l01076"></a>01076         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;(int)hres.mNumFaces;++i)
<a name="l01077"></a>01077         {
<a name="l01078"></a>01078                 <span class="keyword">const</span> <span class="keywordtype">int</span> idx[]={       <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(hres.m_Indices[i*3+0]),
<a name="l01079"></a>01079                                                         static_cast&lt;int&gt;(hres.m_Indices[i*3+1]),
<a name="l01080"></a>01080                                                         <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(hres.m_Indices[i*3+2])};
<a name="l01081"></a>01081                 <span class="keywordflow">if</span>(idx[0]&lt;idx[1]) psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(      idx[0],idx[1]);
<a name="l01082"></a>01082                 <span class="keywordflow">if</span>(idx[1]&lt;idx[2]) psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(      idx[1],idx[2]);
<a name="l01083"></a>01083                 <span class="keywordflow">if</span>(idx[2]&lt;idx[0]) psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(      idx[2],idx[0]);
<a name="l01084"></a>01084                 psb-&gt;<a class="code" href="classbt_soft_body.html#1a89dadf0b4a8d9553d5e2263c034b07">appendFace</a>(idx[0],idx[1],idx[2]);
<a name="l01085"></a>01085         }
<a name="l01086"></a>01086         hlib.<a class="code" href="class_hull_library.html#1694479ac11e270c9f8f13164c0f6dcf">ReleaseResult</a>(hres);
<a name="l01087"></a>01087         <span class="keywordflow">if</span> (randomizeConstraints)
<a name="l01088"></a>01088         {
<a name="l01089"></a>01089                 psb-&gt;<a class="code" href="classbt_soft_body.html#cc984ed7b1ae0c8520d474f4ba3e053f">randomizeConstraints</a>();
<a name="l01090"></a>01090         }
<a name="l01091"></a>01091         <span class="keywordflow">return</span>(psb);
<a name="l01092"></a>01092 }
<a name="l01093"></a>01093 
<a name="l01094"></a>01094 
<a name="l01095"></a>01095 
<a name="l01096"></a>01096 
<a name="l01097"></a>01097 <span class="keyword">static</span> <span class="keywordtype">int</span> nextLine(<span class="keyword">const</span> <span class="keywordtype">char</span>* buffer)
<a name="l01098"></a>01098 {
<a name="l01099"></a>01099         <span class="keywordtype">int</span> numBytesRead=0;
<a name="l01100"></a>01100 
<a name="l01101"></a>01101         <span class="keywordflow">while</span> (*buffer != <span class="charliteral">'\n'</span>)
<a name="l01102"></a>01102         {
<a name="l01103"></a>01103                 buffer++;
<a name="l01104"></a>01104                 numBytesRead++;
<a name="l01105"></a>01105         }
<a name="l01106"></a>01106 
<a name="l01107"></a>01107         
<a name="l01108"></a>01108         <span class="keywordflow">if</span> (buffer[0]==0x0a)
<a name="l01109"></a>01109         {
<a name="l01110"></a>01110                 buffer++;
<a name="l01111"></a>01111                 numBytesRead++;
<a name="l01112"></a>01112         }
<a name="l01113"></a>01113         <span class="keywordflow">return</span> numBytesRead;
<a name="l01114"></a>01114 }
<a name="l01115"></a>01115 
<a name="l01116"></a>01116 <span class="comment">/* Create from TetGen .ele, .face, .node data                                                   */</span> 
<a name="l01117"></a>01117 <a class="code" href="classbt_soft_body.html">btSoftBody</a>*     btSoftBodyHelpers::CreateFromTetGenData(btSoftBodyWorldInfo&amp; worldInfo,
<a name="l01118"></a>01118                                                                                                         <span class="keyword">const</span> <span class="keywordtype">char</span>* ele,
<a name="l01119"></a>01119                                                                                                         <span class="keyword">const</span> <span class="keywordtype">char</span>* face,
<a name="l01120"></a>01120                                                                                                         <span class="keyword">const</span> <span class="keywordtype">char</span>* node,
<a name="l01121"></a>01121                                                                                                         <span class="keywordtype">bool</span> bfacelinks,
<a name="l01122"></a>01122                                                                                                         <span class="keywordtype">bool</span> btetralinks,
<a name="l01123"></a>01123                                                                                                         <span class="keywordtype">bool</span> bfacesfromtetras)
<a name="l01124"></a>01124 {
<a name="l01125"></a>01125 <a class="code" href="classbt_aligned_object_array.html">btAlignedObjectArray&lt;btVector3&gt;</a> pos;
<a name="l01126"></a>01126 <span class="keywordtype">int</span>                                                             nnode=0;
<a name="l01127"></a>01127 <span class="keywordtype">int</span>                                                             ndims=0;
<a name="l01128"></a>01128 <span class="keywordtype">int</span>                                                             nattrb=0;
<a name="l01129"></a>01129 <span class="keywordtype">int</span>                                                             hasbounds=0;
<a name="l01130"></a>01130 <span class="keywordtype">int</span> result = sscanf(node,<span class="stringliteral">"%d %d %d %d"</span>,&amp;nnode,&amp;ndims,&amp;nattrb,&amp;hasbounds);
<a name="l01131"></a>01131 result = sscanf(node,<span class="stringliteral">"%d %d %d %d"</span>,&amp;nnode,&amp;ndims,&amp;nattrb,&amp;hasbounds);
<a name="l01132"></a>01132 node += nextLine(node);
<a name="l01133"></a>01133 
<a name="l01134"></a>01134 pos.<a class="code" href="classbt_aligned_object_array.html#6a48cd9cb91d0cfa50ee1c70ef485190">resize</a>(nnode);
<a name="l01135"></a>01135 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;pos.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>();++i)
<a name="l01136"></a>01136         {
<a name="l01137"></a>01137         <span class="keywordtype">int</span>                     index=0;
<a name="l01138"></a>01138         <span class="comment">//int                   bound=0;</span>
<a name="l01139"></a>01139         <span class="keywordtype">float</span>   x,y,z;
<a name="l01140"></a>01140         sscanf(node,<span class="stringliteral">"%d %f %f %f"</span>,&amp;index,&amp;x,&amp;y,&amp;z);
<a name="l01141"></a>01141 
<a name="l01142"></a>01142 <span class="comment">//      sn&gt;&gt;index;</span>
<a name="l01143"></a>01143 <span class="comment">//      sn&gt;&gt;x;sn&gt;&gt;y;sn&gt;&gt;z;</span>
<a name="l01144"></a>01144         node += nextLine(node);
<a name="l01145"></a>01145 
<a name="l01146"></a>01146         <span class="comment">//for(int j=0;j&lt;nattrb;++j) </span>
<a name="l01147"></a>01147         <span class="comment">//      sn&gt;&gt;a;</span>
<a name="l01148"></a>01148 
<a name="l01149"></a>01149         <span class="comment">//if(hasbounds) </span>
<a name="l01150"></a>01150         <span class="comment">//      sn&gt;&gt;bound;</span>
<a name="l01151"></a>01151 
<a name="l01152"></a>01152         pos[index].setX(btScalar(x));
<a name="l01153"></a>01153         pos[index].setY(btScalar(y));
<a name="l01154"></a>01154         pos[index].setZ(btScalar(z));
<a name="l01155"></a>01155         }
<a name="l01156"></a>01156 <a class="code" href="classbt_soft_body.html">btSoftBody</a>*                                             psb=<span class="keyword">new</span> <a class="code" href="classbt_soft_body.html">btSoftBody</a>(&amp;worldInfo,nnode,&amp;pos[0],0);
<a name="l01157"></a>01157 <span class="preprocessor">#if 0</span>
<a name="l01158"></a>01158 <span class="preprocessor"></span><span class="keywordflow">if</span>(face&amp;&amp;face[0])
<a name="l01159"></a>01159         {
<a name="l01160"></a>01160         <span class="keywordtype">int</span>                                                             nface=0;
<a name="l01161"></a>01161         sf&gt;&gt;nface;sf&gt;&gt;hasbounds;
<a name="l01162"></a>01162         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;nface;++i)
<a name="l01163"></a>01163                 {
<a name="l01164"></a>01164                 <span class="keywordtype">int</span>                     index=0;
<a name="l01165"></a>01165                 <span class="keywordtype">int</span>                     bound=0;
<a name="l01166"></a>01166                 <span class="keywordtype">int</span>                     ni[3];
<a name="l01167"></a>01167                 sf&gt;&gt;index;
<a name="l01168"></a>01168                 sf&gt;&gt;ni[0];sf&gt;&gt;ni[1];sf&gt;&gt;ni[2];
<a name="l01169"></a>01169                 sf&gt;&gt;bound;
<a name="l01170"></a>01170                 psb-&gt;<a class="code" href="classbt_soft_body.html#1a89dadf0b4a8d9553d5e2263c034b07">appendFace</a>(ni[0],ni[1],ni[2]);     
<a name="l01171"></a>01171                 <span class="keywordflow">if</span>(btetralinks)
<a name="l01172"></a>01172                         {
<a name="l01173"></a>01173                         psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(ni[0],ni[1],0,<span class="keyword">true</span>);
<a name="l01174"></a>01174                         psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(ni[1],ni[2],0,<span class="keyword">true</span>);
<a name="l01175"></a>01175                         psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(ni[2],ni[0],0,<span class="keyword">true</span>);
<a name="l01176"></a>01176                         }
<a name="l01177"></a>01177                 }
<a name="l01178"></a>01178         }
<a name="l01179"></a>01179 <span class="preprocessor">#endif</span>
<a name="l01180"></a>01180 <span class="preprocessor"></span>
<a name="l01181"></a>01181 <span class="keywordflow">if</span>(ele&amp;&amp;ele[0])
<a name="l01182"></a>01182         {
<a name="l01183"></a>01183         <span class="keywordtype">int</span>                                                             ntetra=0;
<a name="l01184"></a>01184         <span class="keywordtype">int</span>                                                             ncorner=0;
<a name="l01185"></a>01185         <span class="keywordtype">int</span>                                                             neattrb=0;
<a name="l01186"></a>01186         sscanf(ele,<span class="stringliteral">"%d %d %d"</span>,&amp;ntetra,&amp;ncorner,&amp;neattrb);
<a name="l01187"></a>01187         ele += nextLine(ele);
<a name="l01188"></a>01188         
<a name="l01189"></a>01189         <span class="comment">//se&gt;&gt;ntetra;se&gt;&gt;ncorner;se&gt;&gt;neattrb;</span>
<a name="l01190"></a>01190         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;ntetra;++i)
<a name="l01191"></a>01191                 {
<a name="l01192"></a>01192                 <span class="keywordtype">int</span>                     index=0;
<a name="l01193"></a>01193                 <span class="keywordtype">int</span>                     ni[4];
<a name="l01194"></a>01194 
<a name="l01195"></a>01195                 <span class="comment">//se&gt;&gt;index;</span>
<a name="l01196"></a>01196                 <span class="comment">//se&gt;&gt;ni[0];se&gt;&gt;ni[1];se&gt;&gt;ni[2];se&gt;&gt;ni[3];</span>
<a name="l01197"></a>01197                 sscanf(ele,<span class="stringliteral">"%d %d %d %d %d"</span>,&amp;index,&amp;ni[0],&amp;ni[1],&amp;ni[2],&amp;ni[3]);
<a name="l01198"></a>01198                 ele+=nextLine(ele);
<a name="l01199"></a>01199                 <span class="comment">//for(int j=0;j&lt;neattrb;++j) </span>
<a name="l01200"></a>01200                 <span class="comment">//      se&gt;&gt;a;</span>
<a name="l01201"></a>01201                 psb-&gt;<a class="code" href="classbt_soft_body.html#3d88c896f533e9ea942c746bee29711b">appendTetra</a>(ni[0],ni[1],ni[2],ni[3]);
<a name="l01202"></a>01202                 <span class="keywordflow">if</span>(btetralinks)
<a name="l01203"></a>01203                         {
<a name="l01204"></a>01204                         psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(ni[0],ni[1],0,<span class="keyword">true</span>);
<a name="l01205"></a>01205                         psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(ni[1],ni[2],0,<span class="keyword">true</span>);
<a name="l01206"></a>01206                         psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(ni[2],ni[0],0,<span class="keyword">true</span>);
<a name="l01207"></a>01207                         psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(ni[0],ni[3],0,<span class="keyword">true</span>);
<a name="l01208"></a>01208                         psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(ni[1],ni[3],0,<span class="keyword">true</span>);
<a name="l01209"></a>01209                         psb-&gt;<a class="code" href="classbt_soft_body.html#d632d23c33118bc061ac171a0a99ad20">appendLink</a>(ni[2],ni[3],0,<span class="keyword">true</span>);
<a name="l01210"></a>01210                         }
<a name="l01211"></a>01211                 }
<a name="l01212"></a>01212         }
<a name="l01213"></a>01213 printf(<span class="stringliteral">"Nodes:  %u\r\n"</span>,psb-&gt;<a class="code" href="classbt_soft_body.html#d53c95f39d517c1b72db24f175e92fb5">m_nodes</a>.<a class="code" href="classbt_aligned_object_array.html#6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>());
<a name="l01214"></a>01214 printf(<span class="stringliteral">"Links:  %u\r\n"</span>,psb-&gt;<a class="code" href="classbt_soft_body.html#b52f85beefd08470be24a0586832ff4e">m_links</a>.size());
<a name="l01215"></a>01215 printf(<span class="stringliteral">"Faces:  %u\r\n"</span>,psb-&gt;<a class="code" href="classbt_soft_body.html#76a8ea9e874b87a9dc51846cc24f3a4f">m_faces</a>.size());
<a name="l01216"></a>01216 printf(<span class="stringliteral">"Tetras: %u\r\n"</span>,psb-&gt;<a class="code" href="classbt_soft_body.html#5d67872e5c52a4d6cee4df5f752f9cfb">m_tetras</a>.size());
<a name="l01217"></a>01217 <span class="keywordflow">return</span>(psb);
<a name="l01218"></a>01218 }
<a name="l01219"></a>01219 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Jun 1 12:56:49 2018 for Assignment2 - OOber Taxi by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
